<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MG Transporte ‚Äî H√≠brido (Offline + Firebase) + Planilla Excel</title>

<!-- Tailwind (CDN) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- SortableJS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- SheetJS (xlsx) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase (optional). If no Firebase config, app will work local-only -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
  :root{ --accent:#7c3aed; --accent2:#06b6d4; }
  body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#071026; color:#e7eef9; }
  [data-theme="light"]{ background:#f6f9fc; color:#071026; }
  .app{ display:flex; min-height:100vh; gap:16px; padding:16px; box-sizing:border-box; }
  .sidebar{ width:280px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:14px; }
  .logo{ width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2)); display:flex;align-items:center;justify-content:center;font-weight:900; color:#fff; }
  .nav{ display:flex; flex-direction:column; gap:8px; margin-top:12px; }
  .nav button{ text-align:left; padding:10px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.03); color:inherit; cursor:pointer; }
  .nav button.active{ background:linear-gradient(90deg, rgba(124,58,237,0.12), rgba(6,182,212,0.04)); box-shadow:0 6px 20px rgba(0,0,0,0.6); }
  .main{ flex:1; display:flex; flex-direction:column; gap:12px; }
  .topbar{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .card{ background:rgba(255,255,255,0.02); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); }
  .btn{ padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; }
  .btn-primary{ background:linear-gradient(90deg,var(--accent),var(--accent2)); color:white; border:none; }
  table{ width:100%; border-collapse:collapse; }
  th,td{ padding:8px; text-align:left; font-size:13px; border-bottom:1px solid rgba(255,255,255,0.03); }
  #mapPlanner{ height:320px; border-radius:8px; overflow:hidden; }
  .muted{ color:rgba(255,255,255,0.6); font-size:13px; }
  .status-pending{ background:#f59e0b; color:#041017; padding:6px 8px; border-radius:8px; font-weight:800; }
  .status-assigned{ background:#10b981; color:white; padding:6px 8px; border-radius:8px; font-weight:800; }
  .status-finished{ background:#6b7280; color:white; padding:6px 8px; border-radius:8px; font-weight:800; }
  @media (max-width:1000px){ .sidebar{ display:none; } .app{ padding:10px; } }
</style>
</head>
<body data-theme="dark">
  <div class="app">
    <aside class="sidebar">
      <div style="display:flex;gap:12px;align-items:center;">
        <div class="logo">MG</div>
        <div>
          <div style="font-weight:800;">MG Transporte</div>
          <div class="muted" style="font-size:12px;">Panel h√≠brido</div>
        </div>
      </div>

      <nav class="nav" id="nav">
        <button class="active" data-page="page-add">‚ûï Agregar Viaje</button>
        <button data-page="page-plan">üó∫ Planificar Rutas</button>
        <button data-page="page-clients">üë• Clientes</button>
        <button data-page="page-drivers">üöó Choferes</button>
        <button data-page="page-vehicles">üîß Veh√≠culos</button>
        <button data-page="page-tickets">‚úâÔ∏è Tickets</button>
        <button data-page="page-settings">‚öôÔ∏è Ajustes</button>
      </nav>

      <div style="margin-top:12px;" class="muted">
        <div>Estado: <span id="syncStatus">Offline</span></div>
        <div style="margin-top:6px;">Backups: <span id="backupCount">0</span></div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <h2 id="pageTitle">Agregar Viaje</h2>
          <div class="muted" id="pageSub">Carg√° viajes ‚Äî luego planific√° rutas.</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;">
          <button id="themeToggle" class="btn btn-primary">Toggle Tema</button>
          <button id="btnExcelPlan" class="btn btn-primary">üìë Exportar Planilla Excel</button>
          <button id="btnExportAll" class="btn">Exportar JSON</button>
          <button id="btnImportAll" class="btn">Importar</button>
          <button id="btnBackupNow" class="btn">Backup ahora</button>
        </div>
      </div>

      <!-- PAGES -->
      <section id="page-add" class="card page">
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <div style="flex:1;min-width:320px;">
            <h3>Formulario - Agregar / Editar</h3>
            <div class="muted">Campos obligatorios (*)</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;">
              <div><label class="muted">* Cliente</label><input id="inClient" class="w-full p-2 rounded" /></div>
              <div><label class="muted">* Celular</label><input id="inPhone" class="w-full p-2 rounded" /></div>
              <div><label class="muted">* Origen (direcci√≥n)</label><input id="inOrigin" class="w-full p-2 rounded" /></div>
              <div><label class="muted">* Localidad origen</label><input id="inOriginLocal" class="w-full p-2 rounded" /></div>
              <div><label class="muted">* Destino (direcci√≥n)</label><input id="inDest" class="w-full p-2 rounded" /></div>
              <div><label class="muted">* Localidad destino</label><input id="inDestLocal" class="w-full p-2 rounded" /></div>
              <div><label class="muted">* Fecha</label><input id="inDate" type="date" class="w-full p-2 rounded" /></div>
              <div><label class="muted">* Hora</label><input id="inTime" type="time" class="w-full p-2 rounded" /></div>
              <div><label class="muted">* Precio</label><input id="inPrice" type="number" class="w-full p-2 rounded" /></div>
              <div><label class="muted">Pasajeros</label><input id="inPax" type="number" min="1" value="1" class="w-full p-2 rounded" /></div>
              <div><label class="muted">Mascota</label>
                <select id="inPet" class="w-full p-2 rounded">
                  <option value="none">Ninguna</option><option value="small">&lt;5kg</option><option value="large">&gt;5kg</option>
                </select>
              </div>
              <div><label class="muted">Menores</label>
                <select id="inMinors" class="w-full p-2 rounded"><option value="no">No</option><option value="si">S√≠</option></select>
              </div>
              <div style="grid-column:1/-1"><label class="muted">Servicio</label>
                <select id="inService" class="w-full p-2 rounded"><option value="compartido">Compartido</option><option value="exclusivo">Exclusivo</option></select>
              </div>
              <div style="grid-column:1/-1"><label class="muted">Observaciones</label><textarea id="inNotes" rows="3" class="w-full p-2 rounded"></textarea></div>
            </div>

            <div style="display:flex;gap:8px;margin-top:10px;">
              <button id="btnSaveTrip" class="btn btn-primary">Guardar viaje</button>
              <button id="btnReset" class="btn">Limpiar</button>
              <div style="flex:1"></div>
              <div class="muted">Modo: <span id="formMode">Nuevo</span></div>
            </div>
          </div>

          <div style="flex:1;min-width:400px;">
            <h3>Viajes</h3>
            <div style="display:flex;gap:8px;margin-top:8px;margin-bottom:8px;">
              <input id="qTrips" placeholder="Buscar..." class="w-full p-2 rounded" />
              <select id="filterState" class="p-2 rounded"><option value="all">Todos</option><option value="Activo">Pendiente</option><option value="Asignado">Asignado</option><option value="Finalizado">Finalizado</option></select>
            </div>
            <div style="max-height:440px; overflow:auto;">
              <table><thead><tr><th>Cliente</th><th>Origen‚ÜíDestino</th><th>Fecha/Hora</th><th>Tipo</th><th>Precio</th><th>Estado</th><th>Acciones</th></tr></thead>
              <tbody id="tbodyTrips"></tbody></table>
            </div>
          </div>
        </div>
      </section>

      <!-- PLANIFICAR -->
      <section id="page-plan" class="card page hidden">
        <div style="display:flex;gap:12px;">
          <div style="width:360px;">
            <h3>Viajes sin asignar</h3>
            <div class="muted">Ordenados por fecha/hora. Arrastr√° al builder o us√° "Agregar".</div>
            <div style="margin-top:8px; display:flex;gap:8px;">
              <button id="btnSortByTime" class="btn">Ordenar</button>
              <button id="btnOptimize" class="btn">Optimizar (por hora)</button>
            </div>
            <div id="pendingList" style="max-height:540px; overflow:auto; margin-top:8px;"></div>
          </div>

          <div style="flex:1;">
            <h3>Mapa</h3>
            <div id="mapPlanner"></div>
            <div class="muted" style="margin-top:6px">Geocoding: Nominatim (OpenStreetMap)</div>
          </div>

          <div style="width:420px;">
            <h3>Ruta en construcci√≥n</h3>
            <div style="display:flex;gap:8px;">
              <select id="selDriver" class="w-full p-2 rounded"></select>
              <select id="selVehicle" class="w-full p-2 rounded"></select>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px;">
              <input id="selRouteDate" type="date" class="p-2 rounded" /><button id="btnCreateRoute" class="btn btn-primary">Crear</button>
            </div>
            <div id="routeBuilder" style="margin-top:8px; border:1px dashed rgba(255,255,255,0.06); min-height:240px; padding:8px; border-radius:8px;"></div>
            <div style="display:flex;gap:8px;margin-top:8px;">
              <button id="btnSaveRoute" class="btn btn-primary" style="display:none">Guardar ruta</button>
              <button id="btnClearRoute" class="btn">Limpiar</button>
              <button id="btnSendDriver" class="btn" style="display:none">Enviar al chofer</button>
            </div>

            <div style="margin-top:12px;">
              <h4>Rutas guardadas</h4>
              <div id="savedRoutes" style="max-height:220px; overflow:auto;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Clientes / Choferes / Veh√≠culos / Tickets / Settings -->
      <section id="page-clients" class="card page hidden">
        <h3>Clientes</h3>
        <div style="display:flex;gap:8px;margin-top:8px;"><input id="qClients" placeholder="Buscar..." class="w-full p-2 rounded" /><button id="btnNewClient" class="btn btn-primary">Nuevo</button></div>
        <div id="clientsArea" style="max-height:520px;overflow:auto;margin-top:8px;"></div>
      </section>

      <section id="page-drivers" class="card page hidden">
        <h3>Choferes</h3>
        <div style="display:flex;gap:8px;margin-top:8px;"><input id="inDriverName" placeholder="Nombre" class="p-2 rounded" /><input id="inDriverPhone" placeholder="Tel" class="p-2 rounded" /><button id="btnAddDriver" class="btn btn-primary">Agregar</button></div>
        <div id="driversArea" style="max-height:520px;overflow:auto;margin-top:8px;"></div>
      </section>

      <section id="page-vehicles" class="card page hidden">
        <h3>Veh√≠culos</h3>
        <div style="display:flex;gap:8px;margin-top:8px;"><input id="inVehModel" placeholder="Modelo" class="p-2 rounded" /><input id="inVehPlate" placeholder="Patente" class="p-2 rounded" /><button id="btnAddVeh" class="btn btn-primary">Agregar</button></div>
        <div id="vehiclesArea" style="max-height:520px;overflow:auto;margin-top:8px;"></div>
      </section>

      <section id="page-tickets" class="card page hidden">
        <h3>Tickets</h3>
        <div class="muted">Buscar viaje y generar ticket (WhatsApp / Mail / PDF).</div>
        <div style="display:flex;gap:8px;margin-top:8px;"><input id="qTickets" placeholder="Buscar..." class="w-full p-2 rounded" /><button id="btnSearchTicket" class="btn btn-primary">Buscar</button></div>
        <div id="ticketsArea" style="max-height:420px; overflow:auto; margin-top:8px;"></div>
      </section>

      <section id="page-settings" class="card page hidden">
        <h3>Ajustes & Backups</h3>
        <div class="muted">Backup diario: el sistema descargar√° un Excel con todas las tablas a la carpeta de descargas (o pedir√° donde guardarlo).</div>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
          <label class="muted">Auto-backup</label>
          <select id="autoBackup" class="p-2 rounded"><option value="0">Desactivado</option><option value="1">Cada 1 d√≠a</option><option value="0.25">Cada 6 horas</option></select>
          <label class="muted">Firebase Sync</label>
          <input id="chkFirebase" type="checkbox" />
          <button id="btnSetFirebase" class="btn">Configurar Firebase</button>
        </div>
        <div style="margin-top:12px;">
          <h4>Backups guardados</h4>
          <div id="backupsList" style="max-height:240px; overflow:auto;"></div>
        </div>
        <div style="margin-top:10px;" class="muted">Nota: el navegador no permite escribir archivos sin interacci√≥n del usuario. El "backup autom√°tico" descarga el archivo a la carpeta de descargas.</div>
      </section>

    </main>
  </div>

  <!-- Modal -->
  <div id="modal" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:60;">
    <div style="width:760px; max-width:95%; background:var(--panel, #071026); border-radius:12px; padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong id="modalTitle">Modal</strong>
        <button id="modalClose" class="btn">Cerrar</button>
      </div>
      <div id="modalBody" style="margin-top:12px;"></div>
    </div>
  </div>

<script>
/* -------------------------
  MG Transporte ‚Äî Single file
  H√≠brido offline + Firebase (opcional)
  Planilla Excel con SheetJS + backups
--------------------------*/

/* ---------- Utilities & Storage keys ---------- */
const uid = ()=> Math.random().toString(36).slice(2,9).toUpperCase();
const nowISO = ()=> new Date().toISOString();
const KEYS = { trips:'mg_v5_trips', drivers:'mg_v5_drivers', vehicles:'mg_v5_vehicles', clients:'mg_v5_clients', routes:'mg_v5_routes', backups:'mg_v5_backups', settings:'mg_v5_settings' };
const read = k => JSON.parse(localStorage.getItem(k) || '[]');
const write = (k,v) => localStorage.setItem(k, JSON.stringify(v));

let trips = read(KEYS.trips);
let drivers = read(KEYS.drivers);
let vehicles = read(KEYS.vehicles);
let clients = read(KEYS.clients);
let routes = read(KEYS.routes);
let backups = read(KEYS.backups);
let settings = JSON.parse(localStorage.getItem(KEYS.settings) || JSON.stringify({ theme:'dark', autoBackup:1, firebaseEnabled:false, firebaseConfig:{} }));

/* ---------- DOM refs ---------- */
const pages = document.querySelectorAll('.nav button');
const pageTitle = document.getElementById('pageTitle'); const pageSub = document.getElementById('pageSub');
const themeToggle = document.getElementById('themeToggle'); const body = document.body;
const syncStatus = document.getElementById('syncStatus'); const backupCount = document.getElementById('backupCount');

const inClient = document.getElementById('inClient'); const inPhone = document.getElementById('inPhone'); const inOrigin = document.getElementById('inOrigin'); const inOriginLocal = document.getElementById('inOriginLocal'); const inDest = document.getElementById('inDest'); const inDestLocal = document.getElementById('inDestLocal'); const inDate = document.getElementById('inDate'); const inTime = document.getElementById('inTime'); const inPrice = document.getElementById('inPrice'); const inPax = document.getElementById('inPax'); const inPet = document.getElementById('inPet'); const inMinors = document.getElementById('inMinors'); const inService = document.getElementById('inService'); const inNotes = document.getElementById('inNotes'); const btnSaveTrip = document.getElementById('btnSaveTrip'); const btnReset = document.getElementById('btnReset'); const formMode = document.getElementById('formMode');

const tbodyTrips = document.getElementById('tbodyTrips'); const qTrips = document.getElementById('qTrips'); const filterState = document.getElementById('filterState');

const pendingList = document.getElementById('pendingList'); const routeBuilder = document.getElementById('routeBuilder'); const mapPlannerEl = document.getElementById('mapPlanner'); const selDriver = document.getElementById('selDriver'); const selVehicle = document.getElementById('selVehicle'); const selRouteDate = document.getElementById('selRouteDate'); const btnCreateRoute = document.getElementById('btnCreateRoute'); const btnSaveRoute = document.getElementById('btnSaveRoute'); const btnClearRoute = document.getElementById('btnClearRoute'); const btnSendDriver = document.getElementById('btnSendDriver'); const savedRoutes = document.getElementById('savedRoutes');

const btnExcelPlan = document.getElementById('btnExcelPlan'); const btnExportAll = document.getElementById('btnExportAll'); const btnImportAll = document.getElementById('btnImportAll'); const btnBackupNow = document.getElementById('btnBackupNow');

const qTickets = document.getElementById('qTickets'); const btnSearchTicket = document.getElementById('btnSearchTicket'); const ticketsArea = document.getElementById('ticketsArea');

const inDriverName = document.getElementById('inDriverName'); const inDriverPhone = document.getElementById('inDriverPhone'); const btnAddDriver = document.getElementById('btnAddDriver'); const driversArea = document.getElementById('driversArea');

const inVehModel = document.getElementById('inVehModel'); const inVehPlate = document.getElementById('inVehPlate'); const btnAddVeh = document.getElementById('btnAddVeh'); const vehiclesArea = document.getElementById('vehiclesArea');

const qClients = document.getElementById('qClients'); const btnNewClient = document.getElementById('btnNewClient'); const clientsArea = document.getElementById('clientsArea');

const autoBackup = document.getElementById('autoBackup'); const chkFirebase = document.getElementById('chkFirebase'); const btnSetFirebase = document.getElementById('btnSetFirebase');
const backupsList = document.getElementById('backupsList');

const modal = document.getElementById('modal'); const modalTitle = document.getElementById('modalTitle'); const modalBody = document.getElementById('modalBody'); const modalClose = document.getElementById('modalClose');

/* ---------- Theme & navigation ---------- */
function applyTheme(t){ body.setAttribute('data-theme', t); settings.theme = t; localStorage.setItem(KEYS.settings, JSON.stringify(settings)); }
themeToggle.addEventListener('click', ()=> applyTheme(body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));
applyTheme(settings.theme || 'dark');

/* navigation */
pages.forEach(btn => btn.addEventListener('click', ()=> {
  pages.forEach(b=> b.classList.remove('active')); btn.classList.add('active');
  document.querySelectorAll('.page').forEach(p=> p.classList.add('hidden'));
  const id = btn.dataset.page; document.getElementById(id).classList.remove('hidden'); updateHeader(id);
}));
function updateHeader(id){ const map = { 'page-add':['Agregar Viaje','Carg√° viajes'], 'page-plan':['Planificar Rutas','Mapa + builder'], 'page-clients':['Clientes','Gestionar clientes'], 'page-drivers':['Choferes','Gestionar choferes'], 'page-vehicles':['Veh√≠culos','Gestionar veh√≠culos'], 'page-tickets':['Tickets','Generar tickets'], 'page-settings':['Ajustes','Backups / Sync'] }; const info = map[id]; pageTitle.textContent = info[0]; pageSub.textContent = info[1]; }

/* ---------- Persistencia ---------- */
function persistAll(){ write(KEYS.trips,trips); write(KEYS.drivers,drivers); write(KEYS.vehicles,vehicles); write(KEYS.clients,clients); write(KEYS.routes,routes); write(KEYS.backups,backups); backupCount.textContent = backups.length; }

/* ---------- Map init ---------- */
let map=null, markersLayer=null, poly=null, nominatimCache={};
function initMap(){ try{ map = L.map(mapPlannerEl).setView([-34.61,-58.37],9); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM'}).addTo(map); markersLayer = L.layerGroup().addTo(map); poly = L.polyline([], { color:'#06b6d4', weight:4 }).addTo(map);}catch(e){console.warn(e);} }
initMap();

/* ---------- Geocoding (Nominatim) ---------- */
async function geocode(q){
  if(!q) return null;
  const k = q.trim().toLowerCase();
  if(nominatimCache[k]) return nominatimCache[k];
  try{
    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`, { headers:{ 'Accept-Language':'es' }});
    if(!r.ok) return null;
    const data = await r.json();
    if(!data || !data.length) return null;
    const p = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
    nominatimCache[k] = p; return p;
  }catch(e){ console.warn('geocode',e); return null; }
}

/* ---------- Render functions ---------- */
function formatMoney(v){ return `$ ${Number(v||0).toFixed(2)}`; }
function esc(s){ if(s===undefined||s===null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* Trips render */
function renderTrips(){
  tbodyTrips.innerHTML=''; const q = (qTrips.value||'').toLowerCase(); const state = filterState.value;
  const arr = trips.filter(t=> (state==='all' || (t.status||'Activo')===state) && (!q || (t.clientName||'').toLowerCase().includes(q) || (t.localityOrigin||'').toLowerCase().includes(q) || (t.localityDest||'').toLowerCase().includes(q))).sort((a,b)=> ((a.date||'') + ' ' + (a.time||'')).localeCompare((b.date||'') + ' ' + (b.time||'')));
  if(!arr.length){ tbodyTrips.innerHTML = '<tr><td colspan="7" class="muted">No hay viajes</td></tr>'; return; }
  arr.forEach(t=>{
    const tr = document.createElement('tr'); const status = t.status==='Finalizado' ? `<span class="status-finished">Finalizado</span>` : (t.isAssigned? `<span class="status-assigned">Asignado</span>` : `<span class="status-pending">Pendiente</span>`);
    tr.innerHTML = `<td><strong>${esc(t.clientName)}</strong><div class="muted small">${esc(t.phone)}</div></td><td>${esc(t.localityOrigin)} ${esc(t.addressOrigin)} ‚Üí ${esc(t.localityDest)} ${esc(t.addressDest)}</td><td>${esc(t.date)} ${esc(t.time)}</td><td class="muted">${esc(t.service)}</td><td><strong>${formatMoney(t.price)}</strong></td><td>${status}</td><td style="white-space:nowrap"><button class="btn btn-ghost btn-edit" data-id="${t.id}">Editar</button><button class="btn btn-ghost btn-ticket" data-id="${t.id}">Ticket</button>${t.status!=='Finalizado'? `<button class="btn btn-ghost btn-finish" data-id="${t.id}">Finalizar</button>`: `<button class="btn btn-ghost btn-reopen" data-id="${t.id}">Reabrir</button>` }${!t.isAssigned? `<button class="btn btn-ghost btn-assign" data-id="${t.id}">Asignar</button>` : `<button class="btn btn-ghost btn-unassign" data-id="${t.id}">Desasignar</button>` }</td>`;
    tbodyTrips.appendChild(tr);
  });
  // handlers
  tbodyTrips.querySelectorAll('.btn-edit').forEach(b=> b.addEventListener('click', e=> openEditTrip(e.currentTarget.dataset.id)));
  tbodyTrips.querySelectorAll('.btn-ticket').forEach(b=> b.addEventListener('click', e=> openTicketOptions(e.currentTarget.dataset.id)));
  tbodyTrips.querySelectorAll('.btn-finish').forEach(b=> b.addEventListener('click', e=> finalizeTrip(e.currentTarget.dataset.id)));
  tbodyTrips.querySelectorAll('.btn-reopen').forEach(b=> b.addEventListener('click', e=> reopenTrip(e.currentTarget.dataset.id)));
  tbodyTrips.querySelectorAll('.btn-assign').forEach(b=> b.addEventListener('click', e=> addTripToRoute(e.currentTarget.dataset.id)));
  tbodyTrips.querySelectorAll('.btn-unassign').forEach(b=> b.addEventListener('click', e=> unassignTrip(e.currentTarget.dataset.id)));
}

/* Pending list render */
function renderPending(){
  pendingList.innerHTML='';
  const arr = trips.filter(t=> !t.isAssigned && (t.status||'Activo')!=='Finalizado').sort((a,b)=> ((a.date||'')+' '+(a.time||'')).localeCompare((b.date||'')+' '+(b.time||'')));
  if(!arr.length){ pendingList.innerHTML = '<div class="muted">No hay viajes pendientes</div>'; return; }
  arr.forEach(t=>{
    const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px'; div.draggable=true; div.dataset.tripId=t.id;
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${esc(t.clientName)}</strong><div class="muted small">${esc(t.localityOrigin)}‚Üí${esc(t.localityDest)} ¬∑ ${esc(t.date)} ${esc(t.time)}</div></div><div style="text-align:right"><div><strong>${formatMoney(t.price)}</strong></div><div style="display:flex;gap:6px;margin-top:6px;"><button class="btn btn-ghost btn-add" data-id="${t.id}">Agregar</button><button class="btn btn-ghost btn-edit-small" data-id="${t.id}">‚úé</button></div></div></div>`;
    pendingList.appendChild(div);
  });
  // handlers
  pendingList.querySelectorAll('.btn-add').forEach(b=> b.addEventListener('click', e=> addTripToRoute(e.currentTarget.dataset.id)));
  pendingList.querySelectorAll('.btn-edit-small').forEach(b=> b.addEventListener('click', e=> openEditTrip(e.currentTarget.dataset.id)));
  if(window.pendingSortable) window.pendingSortable.destroy();
  window.pendingSortable = Sortable.create(pendingList, { group:{ name:'shared', pull:'clone', put:false }, sort:false, animation:150 });
}

/* Drivers, Vehicles, Clients render */
function renderDrivers(){ driversArea.innerHTML=''; selDriver.innerHTML='<option value="">-- Seleccionar --</option>'; if(!drivers.length){ driversArea.innerHTML='<div class="muted">Sin choferes</div>'; return; } drivers.forEach(d=>{ selDriver.innerHTML += `<option value="${d.id}">${esc(d.name)}</option>`; const div=document.createElement('div'); div.className='card'; div.style.marginBottom='8px'; div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${esc(d.name)}</strong><div class="muted small">${esc(d.phone)}</div></div><div style="display:flex;gap:6px;"><button class="btn btn-ghost btn-edit-driver" data-id="${d.id}">Editar</button><button class="btn btn-ghost btn-del-driver" data-id="${d.id}">Eliminar</button></div></div>`; driversArea.appendChild(div); }); driversArea.querySelectorAll('.btn-edit-driver').forEach(b=> b.addEventListener('click', e=> editDriver(e.currentTarget.dataset.id))); driversArea.querySelectorAll('.btn-del-driver').forEach(b=> b.addEventListener('click', e=> deleteDriver(e.currentTarget.dataset.id))); }
function renderVehicles(){ vehiclesArea.innerHTML=''; selVehicle.innerHTML='<option value="">-- Seleccionar --</option>'; if(!vehicles.length){ vehiclesArea.innerHTML='<div class="muted">Sin veh√≠culos</div>'; return; } vehicles.forEach(v=>{ selVehicle.innerHTML += `<option value="${v.id}">${esc(v.model)} (${esc(v.plate)})</option>`; const div=document.createElement('div'); div.className='card'; div.style.marginBottom='8px'; div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${esc(v.model)}</strong><div class="muted small">${esc(v.plate)}</div></div><div style="display:flex;gap:6px;"><button class="btn btn-ghost btn-edit-veh" data-id="${v.id}">Editar</button><button class="btn btn-ghost btn-del-veh" data-id="${v.id}">Eliminar</button></div></div>`; vehiclesArea.appendChild(div); }); vehiclesArea.querySelectorAll('.btn-edit-veh').forEach(b=> b.addEventListener('click', e=> editVehicle(e.currentTarget.dataset.id))); vehiclesArea.querySelectorAll('.btn-del-veh').forEach(b=> b.addEventListener('click', e=> deleteVehicle(e.currentTarget.dataset.id))); }
function renderClients(){ clientsArea.innerHTML=''; if(!clients.length){ clientsArea.innerHTML='<div class="muted">Sin clientes</div>'; return; } clients.forEach(c=>{ const div=document.createElement('div'); div.className='card'; div.style.marginBottom='8px'; div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${esc(c.name)}</strong><div class="muted small">${esc(c.phone)}</div></div><div style="display:flex;gap:6px;"><button class="btn btn-ghost btn-edit-client" data-id="${c.id}">Editar</button><button class="btn btn-ghost btn-del-client" data-id="${c.id}">Eliminar</button></div></div>`; clientsArea.appendChild(div); }); clientsArea.querySelectorAll('.btn-edit-client').forEach(b=> b.addEventListener('click', e=> editClient(e.currentTarget.dataset.id))); clientsArea.querySelectorAll('.btn-del-client').forEach(b=> b.addEventListener('click', e=> deleteClient(e.currentTarget.dataset.id))); }

/* Saved routes render */
function renderSavedRoutes(){ savedRoutes.innerHTML=''; if(!routes.length){ savedRoutes.innerHTML='<div class="muted">No hay rutas</div>'; return; } routes.forEach(r=>{ const drv = drivers.find(d=> d.id===r.driverId); const veh = vehicles.find(v=> v.id===r.vehicleId); const div=document.createElement('div'); div.className='card'; div.style.marginBottom='8px'; div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${esc(drv?.name||'Sin chofer')}</strong><div class="muted small">${esc(veh?.model||'')} ¬∑ ${esc(r.date)}</div><div class="muted small">Paradas: ${r.stops.length}</div></div><div style="display:flex;gap:6px;"><button class="btn btn-ghost btn-view-route" data-id="${r.id}">Ver</button><button class="btn btn-ghost btn-del-route" data-id="${r.id}">Eliminar</button></div></div>`; savedRoutes.appendChild(div); }); savedRoutes.querySelectorAll('.btn-view-route').forEach(b=> b.addEventListener('click', e=> viewRoute(e.currentTarget.dataset.id))); savedRoutes.querySelectorAll('.btn-del-route').forEach(b=> b.addEventListener('click', e=> deleteRoute(e.currentTarget.dataset.id))); }

/* ---------- CRUD & actions ---------- */

/* Trips */
function validateTrip(t){ if(!t.clientName) return 'Nombre requerido'; if(!t.phone) return 'Tel√©fono requerido'; if(!t.addressOrigin) return 'Origen requerido'; if(!t.addressDest) return 'Destino requerido'; if(!t.date) return 'Fecha requerida'; if(!t.time) return 'Hora requerida'; if(isNaN(t.price)) return 'Precio inv√°lido'; return null; }

let editingTripId = null;
btnSaveTrip.addEventListener('click', ()=>{
  const data = { clientName: inClient.value.trim(), phone: inPhone.value.trim(), addressOrigin: inOrigin.value.trim(), localityOrigin: inOriginLocal.value.trim(), addressDest: inDest.value.trim(), localityDest: inDestLocal.value.trim(), date: inDate.value, time: inTime.value, price: parseFloat(inPrice.value||0), passengers: parseInt(inPax.value||1), pet: inPet.value, minors: inMinors.value, service: inService.value, notes: inNotes.value };
  const err = validateTrip(data); if(err){ alert(err); return; }
  if(editingTripId){ const idx = trips.findIndex(x=> x.id===editingTripId); if(idx>=0){ trips[idx] = { ...trips[idx], ...data, updatedAt: nowISO() }; alert('Viaje actualizado'); editingTripId=null; formMode.textContent='Nuevo'; } } else { trips.unshift({ id: uid(), ...data, isAssigned:false, assignedRouteId:null, status:'Activo', createdAt: nowISO() }); alert('Viaje creado'); }
  persistAll(); renderAll(); resetForm();
});

function resetForm(){ inClient.value=''; inPhone.value=''; inOrigin.value=''; inOriginLocal.value=''; inDest.value=''; inDestLocal.value=''; inDate.value=''; inTime.value=''; inPrice.value=''; inPax.value='1'; inPet.value='none'; inMinors.value='no'; inService.value='compartido'; inNotes.value=''; editingTripId=null; formMode.textContent='Nuevo'; }

function openEditTrip(id){ const t = trips.find(x=> x.id===id); if(!t) return; editingTripId = id; formMode.textContent='Editando'; inClient.value=t.clientName; inPhone.value=t.phone; inOrigin.value=t.addressOrigin; inOriginLocal.value=t.localityOrigin; inDest.value=t.addressDest; inDestLocal.value=t.localityDest; inDate.value=t.date; inTime.value=t.time; inPrice.value=t.price; inPax.value=t.passengers||1; inPet.value=t.pet||'none'; inMinors.value=t.minors||'no'; inService.value=t.service||'compartido'; inNotes.value=t.notes||''; window.scrollTo({top:0,behavior:'smooth'}); }

function finalizeTrip(id){ if(!confirm('Marcar como finalizado?')) return; const t = trips.find(x=> x.id===id); if(!t) return; t.status='Finalizado'; persistAll(); renderAll(); alert('Viaje finalizado'); }
function reopenTrip(id){ if(!confirm('Reabrir viaje?')) return; const t = trips.find(x=> x.id===id); if(!t) return; t.status='Activo'; persistAll(); renderAll(); }

function unassignTrip(id){ const t = trips.find(x=> x.id===id); if(!t) return; if(!confirm('Desasignar viaje?')) return; t.isAssigned=false; t.assignedRouteId=null; persistAll(); renderAll(); }

/* Drivers */
btnAddDriver.addEventListener('click', ()=> { const n = inDriverName.value.trim(); const p = inDriverPhone.value.trim(); if(!n) return alert('Nombre requerido'); drivers.unshift({ id: uid(), name:n, phone:p, createdAt: nowISO() }); inDriverName.value=''; inDriverPhone.value=''; persistAll(); renderAll(); });
function editDriver(id){ const d = drivers.find(x=> x.id===id); if(!d) return; const nn = prompt('Nombre', d.name); if(nn===null) return; const pp = prompt('Tel', d.phone); d.name=nn; d.phone=pp; persistAll(); renderAll(); }
function deleteDriver(id){ if(!confirm('Eliminar chofer?')) return; drivers = drivers.filter(x=> x.id!==id); persistAll(); renderAll(); }

/* Vehicles */
btnAddVeh.addEventListener('click', ()=> { const m = inVehModel.value.trim(); const pl = inVehPlate.value.trim(); if(!m||!pl) return alert('Modelo y patente'); vehicles.unshift({ id: uid(), model:m, plate:pl, createdAt: nowISO() }); inVehModel.value=''; inVehPlate.value=''; persistAll(); renderAll(); });
function editVehicle(id){ const v = vehicles.find(x=> x.id===id); if(!v) return; const nm = prompt('Modelo', v.model); if(nm===null) return; const np = prompt('Patente', v.plate); v.model=nm; v.plate=np; persistAll(); renderAll(); }
function deleteVehicle(id){ if(!confirm('Eliminar veh?')) return; vehicles = vehicles.filter(x=> x.id!==id); persistAll(); renderAll(); }

/* Clients */
btnNewClient.addEventListener('click', ()=> { const name = prompt('Nombre cliente'); if(!name) return; const phone = prompt('Tel√©fono')||''; clients.unshift({ id: uid(), name, phone, createdAt: nowISO() }); persistAll(); renderAll(); });
function editClient(id){ const c = clients.find(x=> x.id===id); if(!c) return; const nn = prompt('Nombre', c.name); if(nn===null) return; const pp = prompt('Tel', c.phone); c.name=nn; c.phone=pp; persistAll(); renderAll(); }
function deleteClient(id){ if(!confirm('Eliminar cliente?')) return; clients = clients.filter(x=> x.id!==id); persistAll(); renderAll(); }

/* Route builder */
let currentRoute = null;
btnCreateRoute.addEventListener('click', ()=> {
  const driverId = selDriver.value, vehicleId = selVehicle.value, date = selRouteDate.value;
  if(!driverId || !vehicleId || !date) return alert('Eleg√≠ chofer, veh√≠culo y fecha');
  currentRoute = { id: uid(), driverId, vehicleId, date, stops: [], createdAt: nowISO(), status:'Activa' };
  renderRouteBuilder();
  alert('Ruta creada. Agreg√° viajes desde la izquierda.');
});

function addTripToRoute(tripId){
  if(!currentRoute) return alert('Crea una ruta primero.');
  if(currentRoute.stops.includes(tripId)) return alert('Ya agregado');
  currentRoute.stops.push(tripId);
  const t = trips.find(x=> x.id===tripId); if(t) t.isAssigned=true;
  renderRouteBuilder(); renderPending(); updateMapForRoute();
}

function renderRouteBuilder(){
  routeBuilder.innerHTML='';
  if(!currentRoute){ routeBuilder.innerHTML = '<div class="muted">No hay ruta en construcci√≥n</div>'; btnSaveRoute.style.display='none'; btnSendDriver.style.display='none'; return; }
  if(!currentRoute.stops.length){ routeBuilder.innerHTML = '<div class="muted">Ruta vac√≠a</div>'; btnSaveRoute.style.display='none'; btnSendDriver.style.display='none'; return; }
  currentRoute.stops.forEach(id=>{
    const t = trips.find(x=> x.id===id); if(!t) return;
    const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px'; div.dataset.id=t.id;
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${esc(t.clientName)}</strong><div class="muted small">${esc(t.localityOrigin)}‚Üí${esc(t.localityDest)} ¬∑ ${esc(t.date)} ${esc(t.time)}</div></div><div style="display:flex;gap:6px;"><button class="btn btn-ghost btn-up" data-id="${t.id}">‚ñ≤</button><button class="btn btn-ghost btn-down" data-id="${t.id}">‚ñº</button><button class="btn btn-ghost btn-remove" data-id="${t.id}">Quitar</button></div></div>`;
    routeBuilder.appendChild(div);
  });
  routeBuilder.querySelectorAll('.btn-up').forEach(b=> b.addEventListener('click', e=> moveUp(e.currentTarget.dataset.id)));
  routeBuilder.querySelectorAll('.btn-down').forEach(b=> b.addEventListener('click', e=> moveDown(e.currentTarget.dataset.id)));
  routeBuilder.querySelectorAll('.btn-remove').forEach(b=> b.addEventListener('click', e=> removeFromRoute(e.currentTarget.dataset.id)));
  btnSaveRoute.style.display='inline-flex'; btnSendDriver.style.display='inline-flex';
  if(window.routeSortable) window.routeSortable.destroy();
  window.routeSortable = Sortable.create(routeBuilder, { group:{ name:'shared', put:true, pull:false }, animation:150, onAdd(evt){ const tid = evt.item.dataset.tripId || evt.item.getAttribute('data-trip-id'); if(tid) addTripToRoute(tid); evt.item.remove(); }, onUpdate(){ currentRoute.stops = Array.from(routeBuilder.children).map(c=> c.dataset.id).filter(Boolean); updateMapForRoute(); } });
}
function moveUp(id){ const i = currentRoute.stops.indexOf(id); if(i>0){ [currentRoute.stops[i-1],currentRoute.stops[i]]=[currentRoute.stops[i],currentRoute.stops[i-1]]; renderRouteBuilder(); updateMapForRoute(); } }
function moveDown(id){ const i = currentRoute.stops.indexOf(id); if(i>=0 && i<currentRoute.stops.length-1){ [currentRoute.stops[i+1],currentRoute.stops[i]]=[currentRoute.stops[i],currentRoute.stops[i+1]]; renderRouteBuilder(); updateMapForRoute(); } }
function removeFromRoute(id){ currentRoute.stops = currentRoute.stops.filter(x=> x!==id); const t = trips.find(x=> x.id===id); if(t) t.isAssigned=false; renderRouteBuilder(); renderPending(); updateMapForRoute(); }

btnClearRoute.addEventListener('click', ()=> { if(!confirm('Limpiar ruta?')) return; if(currentRoute){ currentRoute.stops.forEach(tid=>{ const t = trips.find(x=> x.id===tid); if(t) t.isAssigned=false; }); currentRoute=null; renderRouteBuilder(); renderPending(); updateMapForRoute(); } });

btnSaveRoute.addEventListener('click', ()=> {
  if(!currentRoute || !currentRoute.stops.length) return alert('Ruta vac√≠a');
  routes.unshift({ id: uid(), driverId: currentRoute.driverId, vehicleId: currentRoute.vehicleId, date: currentRoute.date, stops:[...currentRoute.stops], createdAt: nowISO(), status:'Activa' });
  for(const tid of currentRoute.stops){ const t = trips.find(x=> x.id===tid); if(t){ t.isAssigned=true; t.assignedRouteId = routes[0].id; } }
  persistAll(); currentRoute=null; renderAll(); alert('Ruta guardada');
});

btnSendDriver.addEventListener('click', ()=> {
  if(!currentRoute) return alert('No hay ruta');
  const drv = drivers.find(d=> d.id===currentRoute.driverId); if(!drv) return alert('Chofer no encontrado');
  let msg = `Ruta ${currentRoute.date}\nChofer: ${drv.name}\nParadas:\n`;
  currentRoute.stops.forEach(tid=>{ const t = trips.find(x=> x.id===tid); msg += `- ${t.clientName} ${t.localityOrigin}‚Üí${t.localityDest} ${t.date} ${t.time} Tel:${t.phone}\n`; });
  window.open(`https://wa.me/${(drv.phone||'').replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`,'_blank');
});

/* View/delete saved routes */
function viewRoute(id){ const r = routes.find(x=> x.id===id); if(!r) return; let txt = `Ruta ${r.date}\nChofer: ${drivers.find(d=> d.id===r.driverId)?.name || 'N/D'}\nVeh: ${vehicles.find(v=> v.id===r.vehicleId)?.model || 'N/D'}\nParadas:\n`; r.stops.forEach(tid=>{ const t=trips.find(x=> x.id===tid); txt+=`- ${t.clientName} | ${t.localityOrigin}‚Üí${t.localityDest} ${t.date} ${t.time}\n`; }); const ok = confirm(txt + '\nOK = eliminar y desasignar'); if(ok){ for(const tid of r.stops){ const t = trips.find(x=> x.id===tid); if(t){ t.isAssigned=false; t.assignedRouteId=null; } } routes = routes.filter(x=> x.id!==id); persistAll(); renderAll(); } }
function deleteRoute(id){ if(!confirm('Eliminar ruta?')) return; const r = routes.find(x=> x.id===id); if(r){ for(const tid of r.stops){ const t = trips.find(x=> x.id===tid); if(t){ t.isAssigned=false; t.assignedRouteId=null; } } } routes = routes.filter(x=> x.id!==id); persistAll(); renderAll(); }

/* Tickets */
const { jsPDF } = window.jspdf || {};
function ticketText(t){
  const r = routes.find(rr=> rr.id === t.assignedRouteId);
  const drv = r? drivers.find(d=> d.id===r.driverId): null; const veh = r? vehicles.find(v=> v.id===r.vehicleId): null;
  return `MG Transporte - Ticket\nViaje: ${t.date} ${t.time}\nPasajero: ${t.clientName}\nTel: ${t.phone}\nOrigen: ${t.addressOrigin}, ${t.localityOrigin}\nDestino: ${t.addressDest}, ${t.localityDest}\nPasajeros: ${t.passengers}\nMascota: ${t.pet}\nMenores: ${t.minors}\nServicio: ${t.service}\nPrecio: ${formatMoney(t.price)}\nObservaciones: ${t.notes}\nChofer: ${drv? drv.name + ' - ' + (drv.phone||'') : 'Sin asignar'}\nVeh√≠culo: ${veh? veh.model + ' - ' + (veh.plate||'') : 'Sin asignar'}`;
}
function openTicketOptions(tripId){
  const t = trips.find(x=> x.id===tripId); if(!t) return;
  showModal('Opciones de ticket', `<div style="display:flex;flex-direction:column;gap:8px"><div><strong>${esc(t.clientName)}</strong> ‚Äî ${esc(t.date)} ${esc(t.time)}</div><div style="display:flex;gap:8px"><button id="m-wa" class="btn btn-primary">WhatsApp</button><button id="m-mail" class="btn">Email</button><button id="m-pdf" class="btn">Descargar PDF</button></div></div>`);
  document.getElementById('m-wa').onclick = ()=> { window.open(`https://wa.me/${(t.phone||'').replace(/\D/g,'')}?text=${encodeURIComponent(ticketText(t))}`,'_blank'); };
  document.getElementById('m-mail').onclick = ()=> { location.href = `mailto:${t.phone||''}?subject=${encodeURIComponent('Ticket MG Transporte')}&body=${encodeURIComponent(ticketText(t))}`; };
  document.getElementById('m-pdf').onclick = ()=> { generatePdf(t); hideModal(); };
}
function generatePdf(t){
  if(!jsPDF) return alert('jsPDF no cargado'); const doc = new jsPDF(); doc.setFontSize(16); doc.text('MG Transporte - Ticket',14,20); doc.setFontSize(11); const lines = ticketText(t).split('\n'); let y=36; lines.forEach(l=>{ doc.text(l,14,y); y+=8; }); doc.save(`ticket_${t.clientName.replace(/\s+/g,'_')}_${t.date}.pdf`); }

/* ---------- Backups: Excel generation with SheetJS ---------- */
function buildBackupWorkbook(data){
  /* data: { trips, routes, drivers, vehicles, clients } => builds a workbook with sheets */
  const wb = XLSX.utils.book_new();
  // TRIPS sheet
  const tripsRows = data.trips.map(t=>({
    Fecha: t.date, Hora: t.time, Cliente: t.clientName, Celular: t.phone,
    'Localidad Origen': t.localityOrigin, 'Direccion Origen': t.addressOrigin,
    'Localidad Destino': t.localityDest, 'Direccion Destino': t.addressDest,
    Precio: t.price, Pasajeros: t.passengers, Mascota: t.pet, Menores: t.minors, Servicio: t.service, Estado: t.status, Observaciones: t.notes, RouteId: t.assignedRouteId || ''
  }));
  const wsTrips = XLSX.utils.json_to_sheet(tripsRows);
  XLSX.utils.book_append_sheet(wb, wsTrips, 'Viajes');

  // ROUTES
  const routesRows = data.routes.map(r=> ({ id:r.id, date:r.date, driverId:r.driverId, vehicleId:r.vehicleId, stops: r.stops.join(',') }) );
  const wsRoutes = XLSX.utils.json_to_sheet(routesRows);
  XLSX.utils.book_append_sheet(wb, wsRoutes, 'Rutas');

  // DRIVERS
  const wsDrivers = XLSX.utils.json_to_sheet(data.drivers);
  XLSX.utils.book_append_sheet(wb, wsDrivers, 'Choferes');

  // VEHICLES
  const wsVeh = XLSX.utils.json_to_sheet(data.vehicles);
  XLSX.utils.book_append_sheet(wb, wsVeh, 'Veh√≠culos');

  // CLIENTS
  const wsClients = XLSX.utils.json_to_sheet(data.clients);
  XLSX.utils.book_append_sheet(wb, wsClients, 'Clientes');

  return wb;
}

function downloadWorkbook(wb, filename){
  const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
  const blob = new Blob([wbout], { type: 'application/octet-stream' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
}

/* daily backup: create backup Excel and push to backups[] (local) */
function doBackup(note='auto'){
  const snap = { id: uid(), ts: nowISO(), note, data:{ trips, routes, drivers, vehicles, clients } };
  backups.unshift(snap);
  if(backups.length>60) backups = backups.slice(0,60);
  write(KEYS.backups, backups);
  backupCount.textContent = backups.length;
  // build workbook and download
  const wb = buildBackupWorkbook(snap.data);
  const fname = `backup_MGTransporte_${(new Date()).toISOString().slice(0,10)}.xlsx`;
  downloadWorkbook(wb, fname);
  renderBackups();
}

/* schedule daily backup at midnight (approx) */
function scheduleDailyBackup(){
  const msToMidnight = (()=> {
    const now = new Date(); const next = new Date(now); next.setHours(24,0,5,0); return next - now;
  })();
  setTimeout(()=>{ doBackup('backup-nightly'); setInterval(()=> doBackup('backup-nightly'), 24*3600*1000); }, msToMidnight + 2000);
}

/* render backups list */
function renderBackups(){
  backupsList.innerHTML = '';
  if(!backups.length) backupsList.innerHTML = '<div class="muted">Sin backups</div>';
  backups.forEach(bk=>{
    const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px'; div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${bk.ts}</strong><div class="muted small">${bk.note}</div></div><div style="display:flex;gap:6px"><button class="btn btn-ghost btn-dl" data-id="${bk.id}">Descargar</button><button class="btn btn-ghost btn-restore" data-id="${bk.id}">Restaurar</button></div></div>`; backupsList.appendChild(div);
  });
  backupsList.querySelectorAll('.btn-dl').forEach(b=> b.addEventListener('click', e=> {
    const id = e.currentTarget.dataset.id; const bk = backups.find(x=> x.id===id); if(!bk) return; const wb = buildBackupWorkbook(bk.data); downloadWorkbook(wb, `backup_${bk.ts}.xlsx`);
  }));
  backupsList.querySelectorAll('.btn-restore').forEach(b=> b.addEventListener('click', e=> {
    if(!confirm('Restaurar backup y reemplazar datos locales?')) return;
    const id = e.currentTarget.dataset.id; const bk = backups.find(x=> x.id===id); if(!bk) return;
    trips = bk.data.trips || []; drivers = bk.data.drivers || []; vehicles = bk.data.vehicles || []; clients = bk.data.clients || []; routes = bk.data.routes || [];
    persistAll(); renderAll(); alert('Backup restaurado');
  }));
}

/* ---------- Excel "Planilla" (como tu foto) ---------- */
function exportPlanillaExcel(){
  // Build workbook with a sheet per month using trips
  const byMonth = {};
  trips.forEach(t=>{
    const d = t.date || ''; const month = d ? d.slice(0,7) : 'sin_fecha'; // YYYY-MM
    if(!byMonth[month]) byMonth[month]=[];
    byMonth[month].push(t);
  });
  const wb = XLSX.utils.book_new();
  for(const mon of Object.keys(byMonth).sort()){
    const rows = byMonth[mon].map(t=>({
      Fecha: t.date, 'Hora Salida': t.time, Cliente: t.clientName, Celular: t.phone, 'Localidad Origen': t.localityOrigin, 'Direccion Origen': t.addressOrigin, 'Localidad Destino': t.localityDest, 'Direccion Destino': t.addressDest, 'Precio Viaje': t.price, Estado: t.status, Observaciones: t.notes
    }));
    const ws = XLSX.utils.json_to_sheet(rows, { origin: 'A1' });
    // optional: add totals at bottom
    const total = rows.reduce((s,r)=> s + (Number(r['Precio Viaje'])||0), 0);
    const lastRow = rows.length + 3;
    XLSX.utils.sheet_add_aoa(ws, [['Total viajes', rows.length], ['Total facturado', total]], { origin: `A${lastRow}`});
    const sheetName = mon === 'sin_fecha' ? 'SinFecha' : mon;
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
  }
  const fname = `Planilla_Control_Viajes_${(new Date()).toISOString().slice(0,10)}.xlsx`;
  downloadWorkbook(wb, fname);
}

/* ---------- Export / Import JSON ---------- */
function exportJSON(){
  const pack = { trips, drivers, vehicles, clients, routes, ts: nowISO() };
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(pack,null,2)], { type:'application/json' })); a.download = `mg_export_${nowISO().slice(0,10)}.json`; a.click();
}
function importJSON(){
  const fi = document.createElement('input'); fi.type='file'; fi.accept='application/json';
  fi.onchange = ev => {
    const f = ev.target.files[0]; if(!f) return;
    const r = new FileReader(); r.onload = ()=> {
      try{
        const obj = JSON.parse(r.result);
        if(obj.trips) trips = obj.trips; if(obj.drivers) drivers = obj.drivers; if(obj.vehicles) vehicles = obj.vehicles; if(obj.clients) clients = obj.clients; if(obj.routes) routes = obj.routes;
        persistAll(); renderAll(); alert('Importaci√≥n OK');
      }catch(e){ alert('Error importando JSON'); console.error(e); }
    }; r.readAsText(f);
  };
  fi.click();
}

/* ---------- Small helpers & modal ---------- */
function showModal(title, html){ modalTitle.textContent = title; modalBody.innerHTML = html; modal.style.display='flex'; }
function hideModal(){ modal.style.display='none'; }
modalClose.addEventListener('click', hideModal);

/* ---------- Map update for current route ---------- */
async function updateMapForRoute(){
  if(!map || !currentRoute) return;
  markersLayer.clearLayers(); poly.setLatLngs([]);
  const coords=[];
  for(const tid of currentRoute.stops){
    const t = trips.find(x=> x.id===tid); if(!t) continue;
    const addr = `${t.addressOrigin} ${t.localityOrigin}`;
    const g = await geocode(addr);
    if(g){ coords.push([g.lat,g.lon]); L.marker([g.lat,g.lon]).bindPopup(`<b>${esc(t.clientName)}</b><br>${esc(t.localityOrigin)} ‚Üí ${esc(t.localityDest)}`).addTo(markersLayer); }
  }
  if(coords.length){ poly.setLatLngs(coords); map.fitBounds(poly.getBounds().pad(0.4)); }
}

/* ---------- Initialization & renderAll ---------- */
function renderAll(){ renderTrips(); renderPending(); renderDrivers(); renderVehicles(); renderClients(); renderSavedRoutes(); renderRouteBuilder(); renderBackups(); renderTicketsArea(); }
function renderTicketsArea(){ ticketsArea.innerHTML = ''; const q = (qTickets.value||'').toLowerCase(); const arr = trips.filter(t=> !q || (t.clientName||'').toLowerCase().includes(q) || (t.localityOrigin||'').toLowerCase().includes(q)); if(!arr.length) ticketsArea.innerHTML = '<div class="muted">No hay viajes</div>'; arr.forEach(t=>{ const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px'; div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${esc(t.clientName)}</strong><div class="muted small">${esc(t.date)} ${esc(t.time)} ¬∑ ${esc(t.localityOrigin)}‚Üí${esc(t.localityDest)}</div></div><div style="display:flex;gap:8px;"><button class="btn btn-ghost btn-ticket-open" data-id="${t.id}">Opciones</button></div></div>`; ticketsArea.appendChild(div); }); ticketsArea.querySelectorAll('.btn-ticket-open').forEach(b=> b.addEventListener('click', e=> openTicketOptions(e.currentTarget.dataset.id))); }

/* ---------- Event wiring ---------- */
qTrips.addEventListener('input', renderTrips);
filterState.addEventListener('change', renderTrips);
btnReset.addEventListener('click', resetForm);
btnExcelPlan.addEventListener('click', exportPlanillaExcel);
btnExportAll.addEventListener('click', exportJSON);
btnImportAll.addEventListener('click', importJSON);
btnBackupNow.addEventListener('click', ()=> { doBackup('manual'); alert('Backup descargado'); });

document.getElementById('btnSortByTime').addEventListener('click', ()=> renderPending());
document.getElementById('btnOptimize').addEventListener('click', ()=> { if(!currentRoute) return alert('Crea ruta primero'); currentRoute.stops.sort((a,b)=> ((trips.find(x=>x.id===a).date||'')+' '+(trips.find(x=>x.id===a).time||'')).localeCompare((trips.find(x=>x.id===b).date||'')+' '+(trips.find(x=>x.id===b).time||'')); renderRouteBuilder(); updateMapForRoute(); });

document.getElementById('btnSearchTicket').addEventListener('click', ()=> renderTicketsArea());
document.getElementById('btnAddDriver').addEventListener('click', ()=> {/* handled above */});
document.getElementById('btnAddVeh')?.addEventListener('click', ()=> {});
qTickets.addEventListener('input', renderTicketsArea);

/* ---------- Backups scheduling ---------- */
autoBackup.value = settings.autoBackup || 1;
autoBackup.addEventListener('change', ()=> { settings.autoBackup = parseFloat(autoBackup.value); localStorage.setItem(KEYS.settings, JSON.stringify(settings)); if(settings.autoBackup>0){ scheduleDailyBackup(); } });

/* ---------- Simple offline / online status & queue ---------- */
let online = navigator.onLine;
const pendingQueueKey = 'mg_v5_queue';
let queue = JSON.parse(localStorage.getItem(pendingQueueKey) || '[]');

function setSyncStatus(text){ syncStatus.textContent = text; }
window.addEventListener('online', ()=> { online = true; setSyncStatus('Online - sincronizando'); processQueue(); });
window.addEventListener('offline', ()=> { online = false; setSyncStatus('Offline'); });

function queueChange(action, payload){
  queue.unshift({ id: uid(), ts: nowISO(), action, payload });
  localStorage.setItem(pendingQueueKey, JSON.stringify(queue));
}

/* ---------- Firebase optional sync (basic) ---------- */
let firebaseApp = null, firestore = null;
function initFirebase(config){
  try{
    if(!config || !config.apiKey) return alert('Peg√° tu config de Firebase (objeto) cuando lo pidas');
    firebaseApp = firebase.initializeApp(config);
    firestore = firebase.firestore();
    settings.firebaseEnabled = true; settings.firebaseConfig = config; localStorage.setItem(KEYS.settings, JSON.stringify(settings));
    chkFirebase.checked = true;
    setSyncStatus('Online (Firebase listo)');
    // on reconnect, process queue
    processQueue();
  }catch(e){ console.error('Firebase init', e); alert('Error inicializando Firebase'); }
}

/* example processQueue: push local changes to Firestore simple approach */
async function processQueue(){
  if(!settings.firebaseEnabled || !firestore) { setSyncStatus(online ? 'Online (no sync)' : 'Offline'); return; }
  if(!navigator.onLine) { setSyncStatus('Offline'); return; }
  if(!queue || !queue.length){ setSyncStatus('Online - sin cola'); return; }
  setSyncStatus('Sincronizando...');
  while(queue.length){
    const item = queue.pop();
    try{
      // simple mapping: push trips to collection 'trips'
      if(item.action === 'createTrip'){
        await firestore.collection('trips').doc(item.payload.id).set(item.payload);
      } else if(item.action === 'updateTrip'){
        await firestore.collection('trips').doc(item.payload.id).set(item.payload, { merge:true });
      }
      // other actions: drivers, vehicles, routes -> similar
      localStorage.setItem(pendingQueueKey, JSON.stringify(queue));
    }catch(e){ console.error('processQueue error', e); queue.push(item); localStorage.setItem(pendingQueueKey, JSON.stringify(queue)); break; }
  }
  setSyncStatus('Sincronizaci√≥n finalizada');
}

/* When creating/updating while online+firebase enabled, push directly; else queue */
async function pushOrQueue(action, payload){
  if(settings.firebaseEnabled && firestore && navigator.onLine){
    try{
      if(action==='createTrip') await firestore.collection('trips').doc(payload.id).set(payload);
      if(action==='updateTrip') await firestore.collection('trips').doc(payload.id).set(payload, { merge:true });
    }catch(e){ console.warn('push failed, queuing', e); queueChange(action,payload); }
  } else {
    queueChange(action,payload);
  }
}

/* Hook pushOrQueue into create/update trip */
function persistAllAndMaybePush(){
  persistAll();
  // naive: push all trips in local store to firebase if enabled
  if(settings.firebaseEnabled && firestore && navigator.onLine){
    trips.forEach(t=> pushOrQueue('updateTrip', t));
    drivers.forEach(d=> pushOrQueue('updateDriver', d));
    vehicles.forEach(v=> pushOrQueue('updateVehicle', v));
    clients.forEach(c=> pushOrQueue('updateClient', c));
    routes.forEach(r=> pushOrQueue('updateRoute', r));
  }
}

/* ---------- Final init ---------- */
function initApp(){
  document.getElementById('page-add').classList.remove('hidden'); updateHeader('page-add');
  backupCount.textContent = backups.length;
  renderAll();
  renderBackups();
  if(settings.autoBackup && settings.autoBackup>0) scheduleDailyBackup();
  // bind Firebase config button (opens modal to paste config)
  btnSetFirebase.addEventListener('click', ()=> {
    showModal('Configurar Firebase', `<div style="display:flex;flex-direction:column;gap:8px"><div class="muted">Pega aqu√≠ el objeto de configuraci√≥n de Firebase (JSON). Ej: { "apiKey":"...", "authDomain":"...", ... }</div><textarea id="fbConf" rows="8" class="w-full p-2"></textarea><div style="display:flex;gap:8px"><button id="fbSave" class="btn btn-primary">Guardar y conectar</button><button id="fbClear" class="btn">Limpiar</button></div></div>`);
    document.getElementById('fbSave').addEventListener('click', ()=> {
      try{
        const cfg = JSON.parse(document.getElementById('fbConf').value);
        initFirebase(cfg); hideModal();
      }catch(e){ alert('JSON inv√°lido'); }
    });
    document.getElementById('fbClear').addEventListener('click', ()=> { document.getElementById('fbConf').value=''; });
  });

  // wire queue processing on load if firebase configured
  if(settings.firebaseEnabled && settings.firebaseConfig && Object.keys(settings.firebaseConfig).length) initFirebase(settings.firebaseConfig);
}
initApp();

/* expose some functions for debugging in console */
window.MG = { trips, drivers, vehicles, clients, routes, doBackup, exportPlanillaExcel, persistAllAndMaybePush };

/* final render call */
renderAll();
renderBackups();

</script>
</body>
</html>
