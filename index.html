<!DOCTYPE html>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MG Transporte - Sistema de Viajes Puerta a Puerta</title>
<!-- CDN de Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<!-- Íconos de Lucide -->
<script src="https://unpkg.com/lucide@latest"></script>
<style>
body {
font-family: 'Inter', sans-serif;
background-color: #f7f9fb;
}
/* Colores personalizados */
.color-primary { color: #5B48B3; }
.bg-primary { background-color: #5B48B3; }
.border-primary { border-color: #5B48B3; }
.color-accent { color: #ff8c00; }
.bg-accent { background-color: #ff8c00; }
.ring-accent:focus { --tw-ring-color: #ff8c00; }

.tab-button.active {
border-bottom: 3px solid #ff8c00;
color: #5B48B3;
font-weight: 600;
}
.modal-tab-button.active {
border-bottom: 3px solid #ff8c00;
color: #5B48B3;
font-weight: 600;
}
.route-status-card {
border-left: 4px solid #ff8c00;
}

/* Sub-pestañas para Activos/Finalizados */
.sub-tab-button {
padding: 8px 16px;
border-bottom: 3px solid transparent;
color: #6b7280;
font-weight: 500;
}
.sub-tab-button.active {
border-bottom-color: #5B48B3;
color: #5B48B3;
font-weight: 600;
}

/* Estilo para el Ticket en el Modal */
.printable-ticket {
font-family: 'Inter', sans-serif;
border: 1px solid #e5e7eb;
border-radius: 0.5rem;
background: #ffffff;
padding: 1.5rem;
}
.printable-ticket h4 {
font-size: 1.125rem;
font-weight: 700;
color: #5B48B3;
border-bottom: 2px solid #f3f4f6;
padding-bottom: 0.5rem;
margin-bottom: 1rem;
display: flex;
align-items: center;
}
.printable-ticket .section-title {
font-size: 0.75rem;
font-weight: 600;
color: #6b7280;
text-transform: uppercase;
letter-spacing: 0.05em;
margin-bottom: 0.25rem;
}
.printable-ticket p {
font-size: 0.9rem;
color: #1f2937;
margin-bottom: 0.5rem;
}
.printable-ticket .highlight {
font-size: 1rem;
font-weight: 600;
color: #166534; /* Green */
}
.printable-ticket .pending {
font-size: 0.9rem;
font-weight: 600;
color: #b45309; /* Amber */
}
.printable-ticket .icon {
width: 1rem;
height: 1rem;
margin-right: 0.5rem;
stroke: #5B48B3;
}

/* Estilo para el resumen de Gemini */
.gemini-summary {
background-color: #fdfdea; /* Amarillo pálido */
border: 1px solid #fbf0c0;
border-radius: 0.5rem;
padding: 1rem;
margin-top: 1rem;
margin-bottom: 1rem;
font-size: 0.9rem;
color: #725a03;
}
.gemini-summary p {
margin-bottom: 0.5rem;
color: #725a03;
}
.gemini-summary strong {
color: #5a4802;
}
.gemini-summary ul {
list-style-type: disc;
padding-left: 1.25rem;
}
.gemini-summary-title {
font-weight: 700;
display: flex;
align-items: center;
color: #5a4802;
margin-bottom: 0.5rem;
}
.gemini-summary-title svg {
width: 1rem;
height: 1rem;
margin-right: 0.5rem;
stroke: #725a03;
}


/* Ocultar elementos en la impresión */
@media print {
body * {
visibility: hidden;
}
#printable-area, #printable-area * {
visibility: visible;
}
#printable-area {
position: absolute;
left: 0;
top: 0;
width: 100%;
}
.modal-actions-no-print {
display: none;
}
.gemini-summary {
background-color: #ffffff;
border: 1px solid #eeeeee;
}
}
</style>
</head>
<body class="min-h-screen">

<div id="app" class="max-w-5xl mx-auto p-4 md:p-8">
<header class="text-center mb-6">
<h1 class="text-3xl font-bold text-gray-800 flex items-center justify-center">
<span class="color-primary">MG</span>
<i data-lucide="route" class="w-7 h-7 ml-1 mr-2 color-accent"></i>
<span class="color-primary">Transporte</span>
</h1>
<p class="text-sm text-gray-500 mt-1">Sistema de Viajes Puerta a Puerta</p>
</header>

<!-- Mensajes de estado -->
<div id="status-message" class="hidden p-3 mb-4 text-sm rounded-lg" role="alert"></div>
<div id="auth-status" class="text-center text-xs text-gray-400 mb-4">Conectando a la base de datos...</div>

<!-- Navegación de Pestañas -->
<div class="flex border-b border-gray-200 mb-6 text-sm">
<button id="tab-viajes" class="tab-button active flex-1 py-3 px-1 text-center text-gray-600 transition duration-150">
<i data-lucide="ticket" class="w-4 h-4 inline-block mr-1"></i> Tickets de Viaje
</button>
<button id="tab-rutas" class="tab-button flex-1 py-3 px-1 text-center text-gray-600 transition duration-150">
<i data-lucide="list-checks" class="w-4 h-4 inline-block mr-1"></i> Rutas (Asignación)
</button>
<button id="tab-vehiculos" class="tab-button flex-1 py-3 px-1 text-center text-gray-600 transition duration-150">
<i data-lucide="car" class="w-4 h-4 inline-block mr-1"></i> Vehículos
</button>
<button id="tab-choferes" class="tab-button flex-1 py-3 px-1 text-center text-gray-600 transition duration-150">
<i data-lucide="users" class="w-4 h-4 inline-block mr-1"></i> Choferes
</button>
</div>

<!-- 1. Contenido de VIAJES (Tickets individuales) -->
<div id="content-viajes" class="tab-content">
<!-- Formulario de Viaje (Con todos los datos del Excel) -->
<div class="bg-white p-6 rounded-xl shadow-lg mb-6">
<h2 class="text-xl font-semibold mb-4 text-gray-700">Registrar Nuevo Ticket de Viaje</h2>
<form id="trip-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
<input type="hidden" id="editing-trip-id">
<!-- Cliente y Datos Básicos -->
<div class="md:col-span-2 grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700">Cliente / Pasajero</label>
<input type="text" id="client-name" placeholder="Nombre completo (Columna Cliente)" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
</div>
<div>
<label class="block text-sm font-medium text-gray-700">Teléfono del cliente</label>
<input type="text" id="client-phone" placeholder="Teléfono (Columna Teléfono)" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary">
</div>
</div>
<!-- Origen (Salida) -->
<div class="p-3 border rounded-lg bg-red-50 border-red-200">
<p class="font-bold text-red-700 text-sm mb-2">SALIDA (Origen)</p>
<label class="block text-xs font-medium text-gray-700">Dirección Salida</label>
<input type="text" id="address-origin" placeholder="Dirección (Columna Dirección)" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
<label class="block text-xs font-medium text-gray-700 mt-2">Localidad Salida</label>
<input type="text" id="locality-origin" placeholder="Localidad (Columna Localidad)" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
</div>

<!-- Destino -->
<div class="p-3 border rounded-lg bg-green-50 border-green-200">
<p class="font-bold text-green-700 text-sm mb-2">DESTINO</p>
<label class="block text-xs font-medium text-gray-700">Dirección Destino</label>
<input type="text" id="address-dest" placeholder="Dirección (Columna Dirección)" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
<label class="block text-xs font-medium text-gray-700 mt-2">Localidad Destino</label>
<input type="text" id="locality-dest" placeholder="Localidad (Columna Localidad)" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
</div>

<!-- Fecha, Hora y Precio -->
<div>
<label class="block text-sm font-medium text-gray-700">Fecha de viaje</label>
<input type="date" id="trip-date" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
</div>
<div>
<label class="block text-sm font-medium text-gray-700">Hora Aprox. (Columna Hora)</label>
<input type="time" id="trip-time" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
</div>

<!-- Pasajeros y Mascotas (ACTUALIZADO) -->
<div class="md:col-span-2 grid grid-cols-3 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700">Pasajeros</label>
<input type="number" id="trip-passengers" value="1" min="1" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
</div>
<div>
<label class="block text-sm font-medium text-gray-700">Mascotas (Cant)</label>
<input type="number" id="trip-pets" value="0" min="0" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
</div>
<div>
<label class="block text-sm font-medium text-gray-700">Tamaño Mascota</label>
<select id="trip-pet-size" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary">
<option value="ninguno">Ninguno</option>
<option value="<5kg">Pequeño (&lt;5kg)</option>
<option value=">5kg">Grande (&gt;5kg)</option>
</select>
</div>
</div>

<div class="md:col-span-2">
<label class="block text-sm font-medium text-gray-700">Precio Final (Columna Precio Viaje)</label>
<input type="number" id="trip-price" placeholder="Precio final del viaje (solo números)" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
</div>

<div class="md:col-span-2 mt-4 flex space-x-3">
<button type="submit" id="save-trip-btn" class="w-full bg-primary hover:bg-opacity-90 text-white font-semibold py-3 rounded-xl transition duration-150 shadow-lg shadow-purple-200/50 flex items-center justify-center">
<i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Registrar Ticket
</button>
<button type="button" id="cancel-edit-btn" class="w-1/3 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 rounded-xl transition duration-150 hidden">
Cancelar Edición
</button>
</div>
</form>
</div>

<!-- Listado de Viajes (Boletos) con Sub-Pestañas -->
<div class="bg-white p-6 rounded-xl shadow-lg">
<!-- Sub-pestañas -->
<div class="flex border-b border-gray-200 mb-4">
<button id="sub-tab-activos" class="sub-tab-button active">
<i data-lucide="activity" class="w-4 h-4 inline-block mr-1"></i> Activos
</button>
<button id="sub-tab-finalizados" class="sub-tab-button">
<i data-lucide="check-circle" class="w-4 h-4 inline-block mr-1"></i> Finalizados
</button>
</div>

<!-- Contenido Pestaña Activos -->
<div id="content-activos" class="sub-tab-content">
<h2 class="text-xl font-semibold mb-4 text-gray-700">Tickets Pendientes y Asignados</h2>
<div id="trips-list-active" class="space-y-4">
<p class="text-center text-gray-500" id="loading-trips-active">Cargando tickets activos...</p>
</div>
</div>

<!-- Contenido Pestaña Finalizados -->
<div id="content-finalizados" class="sub-tab-content hidden">
<h2 class="text-xl font-semibold mb-4 text-gray-700">Tickets Finalizados</h2>
<div id="trips-list-finished" class="space-y-4">
<p class="text-center text-gray-500" id="loading-trips-finished">Cargando tickets finalizados...</p>
</div>
</div>
</div>
</div>

<!-- 2. Contenido de RUTAS (Asignación) -->
<div id="content-rutas" class="tab-content hidden">
<div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
<!-- Columna 1: Crear/Ver Rutas -->
<div class="xl:col-span-1">
<div class="bg-white p-6 rounded-xl shadow-lg mb-6 sticky top-0">
<h2 class="text-xl font-semibold mb-4 text-gray-700">Crear Nueva Ruta</h2>
<form id="route-form">
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700">Asignar Chofer</label>
<select id="route-driver-id" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
<option value="">-- Seleccionar Chofer --</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700">Asignar Vehículo</label>
<select id="route-vehicle-id" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
<option value="">-- Seleccionar Vehículo --</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700">Fecha de Ruta</label>
<input type="date" id="route-date" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
</div>
</div>
<button type="submit" class="w-full mt-6 bg-accent hover:bg-opacity-90 text-white font-semibold py-3 rounded-xl transition duration-150 shadow-lg shadow-yellow-200/50 flex items-center justify-center">
<i data-lucide="plus-square" class="w-5 h-5 mr-2"></i> Crear Ruta Vacía
</button>
</form>
</div>

<div class="bg-white p-6 rounded-xl shadow-lg">
<h3 class="font-semibold text-gray-700 mb-3">Rutas Activas</h3>
<div id="active-routes-list" class="space-y-3">
<p class="text-center text-xs text-gray-400" id="loading-routes">Cargando rutas...</p>
<!-- Rutas activas se renderizan aquí -->
</div>
</div>
</div>

<!-- Columna 2 y 3: Detalles de Ruta y Viajes Pendientes -->
<div class="xl:col-span-2">
<!-- Detalle de la Ruta Seleccionada -->
<div class="bg-white p-6 rounded-xl shadow-lg mb-6">
<h2 class="text-xl font-semibold mb-4 text-gray-700 flex justify-between items-center">
Detalle de Ruta <span id="route-id-display" class="text-sm text-gray-500 font-mono"></span>
</h2>
<div id="route-details-info" class="p-4 bg-gray-50 rounded-lg">
<p id="route-driver-details" class="font-medium text-gray-700"></p>
<p id="route-vehicle-details" class="text-sm text-gray-600"></p>
<p id="route-date-details" class="text-sm text-gray-500"></p>
<p id="route-total-price" class="font-bold text-lg text-green-600 mt-2"></p>
<div id="route-ticket-buttons" class="mt-4 flex space-x-3">
<button id="view-route-ticket-btn" class="bg-primary text-white text-sm font-medium py-2 px-4 rounded-lg flex items-center transition-all duration-150" disabled>
<i data-lucide="printer" class="w-4 h-4 mr-2"></i> Ver Ticket Chofer
</button>
<button id="finalize-route-btn" class="bg-red-500 text-white text-sm font-medium py-2 px-4 rounded-lg flex items-center" disabled>
<i data-lucide="check-circle-2" class="w-4 h-4 mr-2"></i> Finalizar Ruta
</button>
</div>
</div>
<h3 class="font-semibold text-gray-700 mt-6 mb-3 flex items-center">
<i data-lucide="list-ordered" class="w-4 h-4 mr-2 color-primary"></i> Tramos Asignados
</h3>
<div id="assigned-trips-list" class="space-y-3">
<p class="text-center text-gray-500 text-sm">Selecciona una ruta activa para ver los viajes asignados.</p>
</div>
</div>

<!-- Viajes Pendientes -->
<div class="bg-white p-6 rounded-xl shadow-lg">
<h3 class="font-semibold text-gray-700 mb-4 flex items-center">
<i data-lucide="package-open" class="w-4 h-4 mr-2 color-accent"></i> Tickets Pendientes de Asignación
</h3>
<div id="pending-trips-list" class="space-y-3">
<p class="text-center text-gray-500 text-sm" id="loading-pending-trips">Cargando tickets pendientes...</p>
</div>
</div>
</div>
</div>
</div>


<!-- 3. Contenido de VEHÍCULOS (Autos) -->
<div id="content-vehiculos" class="tab-content hidden">
<!-- Formulario de Vehículo -->
<div class="bg-white p-6 rounded-xl shadow-lg mb-6">
<h2 class="text-xl font-semibold mb-4 text-gray-700">Registrar Nuevo Vehículo</h2>
<form id="vehicle-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700">Modelo</label>
<input type="text" id="vehicle-model" placeholder="Ej: Renault Trafic" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
</div>
<div>
<label class="block text-sm font-medium text-gray-700">Color</label>
<input type="text" id="vehicle-color" placeholder="Ej: Blanco" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
</div>
<div class="md:col-span-2">
<label class="block text-sm font-medium text-gray-700">Patente / Matrícula</label>
<input type="text" id="vehicle-plate" placeholder="Ej: ABC 123 (Único)" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
</div>
<div class="md:col-span-2 mt-4">
<button type="submit" class="w-full bg-accent hover:bg-opacity-90 text-white font-semibold py-3 rounded-xl transition duration-150 shadow-lg shadow-yellow-200/50 flex items-center justify-center">
<i data-lucide="car-front" class="w-5 h-5 mr-2"></i> Guardar Vehículo
</button>
</div>
</form>
</div>

<!-- Listado de Vehículos -->
<div class="bg-white p-6 rounded-xl shadow-lg">
<h2 class="text-xl font-semibold mb-4 text-gray-700">Vehículos Registrados</h2>
<div id="vehicles-list" class="space-y-4">
<p class="text-center text-gray-500" id="loading-vehicles">Cargando vehículos...</p>
</div>
</div>
</div>

<!-- 4. Contenido de CHOFERES -->
<div id="content-choferes" class="tab-content hidden">
<!-- Formulario de Chofer -->
<div class="bg-white p-6 rounded-xl shadow-lg mb-6">
<h2 class="text-xl font-semibold mb-4 text-gray-700">Agregar Nuevo Chofer</h2>
<form id="driver-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700">Nombre completo</label>
<input type="text" id="driver-name" placeholder="Ej: Juan Pérez" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
</div>
<div>
<label class="block text-sm font-medium text-gray-700">DNI</label>
<input type="text" id="driver-dni" placeholder="DNI del chofer" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
</div>
<div class="md:col-span-2">
<label class="block text-sm font-medium text-gray-700">Teléfono</label>
<input type="text" id="driver-phone" placeholder="Teléfono de contacto" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-4 ring-accent focus:border-primary" required>
</div>
<div class="md:col-span-2 mt-4">
<button type="submit" class="w-full bg-primary hover:bg-opacity-90 text-white font-semibold py-3 rounded-xl transition duration-150 shadow-lg shadow-purple-200/50 flex items-center justify-center">
<i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> Guardar Chofer
</button>
</div>
</form>
</div>

<!-- Listado de Choferes -->
<div class="bg-white p-6 rounded-xl shadow-lg">
<h2 class="text-xl font-semibold mb-4 text-gray-700">Choferes Activos</h2>
<div id="drivers-list" class="space-y-4">
<p class="text-center text-gray-500" id="loading-drivers">Cargando choferes...</p>
</div>
</div>
</div>

<!-- Modal para Generación de Ticket (Oculto y Mejorado) -->
<div id="ticket-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
<!-- Contenedor del Modal con altura máxima y flex-col -->
<div class="bg-gray-100 p-6 rounded-xl shadow-2xl max-w-2xl w-full transform transition-all max-h-[90vh] flex flex-col">
<!-- Encabezado (No se encoge) -->
<div class="flex justify-between items-center mb-4 flex-shrink-0">
<h3 class="text-xl font-bold text-gray-800 flex items-center">
<i data-lucide="file-text" class="w-6 h-6 mr-2 color-accent"></i> Ticket Generado
</h3>
<button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
<i data-lucide="x" class="w-6 h-6"></i>
</button>
</div>

<!-- Pestañas de Ticket (No se encoge) -->
<div class="flex border-b border-gray-300 mb-4 flex-shrink-0">
<button id="modal-tab-client" class="modal-tab-button active flex-1 py-2 px-1 text-center text-gray-600 text-sm transition duration-150">Mensaje Cliente</button>
<button id="modal-tab-driver" class="modal-tab-button flex-1 py-2 px-1 text-center text-gray-600 text-sm transition duration-150">Ticket Receptoría</button>
</div>

<!-- Contenido del ticket (Esta área se scrollea) -->
<div id="printable-area" class="overflow-y-auto">
<div id="modal-content-client" class="modal-tab-content">
<!-- El HTML del ticket del cliente se inyectará aquí -->
</div>
<div id="modal-content-driver" class_name="modal-tab-content hidden">
<!-- El HTML del ticket del chofer se inyectará aquí -->
</div>
</div>

<!-- Acciones del Modal (No se encoge) -->
<div class="mt-6 pt-4 border-t border-gray-300 flex flex-wrap gap-2 modal-actions-no-print flex-shrink-0">
<button id="print-ticket-btn" class="bg-gray-700 hover:bg-gray-800 text-white font-medium py-2 px-4 rounded-lg flex items-center text-sm">
<i data-lucide="printer" class="w-4 h-4 mr-2"></i> Imprimir
</button>
<button id="share-whatsapp-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg flex items-center text-sm">
<i data-lucide="message-circle" class="w-4 h-4 mr-2"></i> WhatsApp
</button>
<button id="share-email-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center text-sm">
<i data-lucide="mail" class="w-4 h-4 mr-2"></i> Email
</button>
<button id="copy-message-btn" class="bg-primary hover:bg-opacity-90 text-white font-medium py-2 px-4 rounded-lg flex items-center text-sm">
<i data-lucide="copy" class="w-4 h-4 mr-2"></i> Copiar Texto
</button>
</div>
</div>
</div>
<!-- Fin del Modal -->

</div>

<!-- FIREBASE y SCRIPTS JS -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, addDoc, onSnapshot, collection, query, where, updateDoc, serverTimestamp, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// Establecer nivel de log para depuración de Firestore
setLogLevel('debug');

// --- Variables Globales de Firebase (PROPORCIONADAS POR EL ENTORNO) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

let db, auth, userId;
let driversData = []; // Caché para choferes
let vehiclesData = []; // Caché para vehículos
let currentRouteData = null; // Ruta seleccionada en la pestaña Rutas
let allTripsData = []; // Caché de todos los tickets
let allRoutesData = [];
let currentlyEditingTripId = null; // ID del viaje que se está editando

// Almacena el TEXTO de los tickets generados para compartir
let modalTicketData = {
client: { html: '', text: '' },
driver: { html: '', text: '' }
};

const statusMessageEl = document.getElementById('status-message');
const authStatusEl = document.getElementById('auth-status');

// --- Funciones de Utilidad y UI ---
function showStatus(message, type = 'success') {
statusMessageEl.textContent = message;
statusMessageEl.className = `p-3 mb-4 text-sm rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
statusMessageEl.classList.remove('hidden');
setTimeout(() => statusMessageEl.classList.add('hidden'), 5000);
}

function formatPrice(number) {
if (number === undefined || number === null) return 'N/A';
return `$ ${Number(number).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
}

// --- LÓGICA DE PESTAÑAS (PRINCIPALES Y SUB-PESTAÑAS) ---
function setupTabs() {
// Pestañas Principales
const tabs = {
'tab-viajes': 'content-viajes',
'tab-rutas': 'content-rutas',
'tab-vehiculos': 'content-vehiculos',
'tab-choferes': 'content-choferes'
};
document.querySelectorAll('.tab-button').forEach(button => {
button.addEventListener('click', (e) => {
document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

button.classList.add('active');
const contentId = tabs[button.id];
if (contentId) {
document.getElementById(contentId).classList.remove('hidden');
}
if (button.id === 'tab-rutas') {
renderPendingTripsList();
updateRouteDetails(currentRouteData);
}
lucide.createIcons();
});
});
document.getElementById('content-viajes').classList.remove('hidden');
document.getElementById('tab-viajes').classList.add('active');

// Sub-Pestañas (Activos/Finalizados)
document.getElementById('sub-tab-activos').addEventListener('click', () => {
document.getElementById('content-activos').classList.remove('hidden');
document.getElementById('content-finalizados').classList.add('hidden');
document.getElementById('sub-tab-activos').classList.add('active');
document.getElementById('sub-tab-finalizados').classList.remove('active');
});
document.getElementById('sub-tab-finalizados').addEventListener('click', () => {
document.getElementById('content-activos').classList.add('hidden');
document.getElementById('content-finalizados').classList.remove('hidden');
document.getElementById('sub-tab-activos').classList.remove('active');
document.getElementById('sub-tab-finalizados').classList.add('active');
});
}


// --- INICIALIZACIÓN Y AUTENTICACIÓN DE FIREBASE ---
if (firebaseConfig) {
try {
const app = initializeApp(firebaseConfig);
db = getFirestore(app);
auth = getAuth(app);
authStatusEl.textContent = 'Autenticando usuario...';

onAuthStateChanged(auth, async (user) => {
if (user) {
userId = user.uid;
authStatusEl.textContent = `✅ Conectado | ID de Usuario: ${userId}`;
listenForVehicles();
listenForDrivers();
listenForTrips();
listenForRoutes();
setupRouteAssignmentLogic();
} else {
if (initialAuthToken) {
await signInWithCustomToken(auth, initialAuthToken);
} else {
await signInAnonymously(auth);
}
}
});
} catch (error) {
console.error("Error al inicializar Firebase:", error);
authStatusEl.textContent = `❌ Error de conexión. Revisa la consola.`;
showStatus('Error al conectar con la base de datos.', 'error');
}
} else {
authStatusEl.textContent = '❌ Configuración de Firebase faltante.';
showStatus('Falta la configuración de Firebase para la persistencia de datos.', 'error');
}


// --- COLECCIONES ---
const VEHICLES_COLLECTION = () => `artifacts/${appId}/users/${userId}/vehicles`;
const DRIVERS_COLLECTION = () => `artifacts/${appId}/users/${userId}/drivers`;
const TRIPS_COLLECTION = () => `artifacts/${appId}/users/${userId}/trips`;
const ROUTES_COLLECTION = () => `artifacts/${appId}/users/${userId}/routes`;

// --- SECCIÓN DE GEMINI API ---

/**
* Maneja las llamadas a la API de Gemini con reintento y backoff exponencial.
*/
async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
try {
const response = await fetch(url, options);
if (!response.ok) {
if (response.status === 429 && retries > 0) {
// console.warn(`Throttled. Retrying in ${delay}ms... (${retries} retries left)`);
await new Promise(resolve => setTimeout(resolve, delay));
return fetchWithBackoff(url, options, retries - 1, delay * 2);
}
throw new Error(`HTTP error! status: ${response.status}`);
}
return response.json();
} catch (error) {
// console.error("Error fetching Gemini:", error);
if (retries > 0) {
// console.warn(`Fetch error. Retrying in ${delay}ms... (${retries} retries left)`);
await new Promise(resolve => setTimeout(resolve, delay));
return fetchWithBackoff(url, options, retries - 1, delay * 2);
}
// console.error("Max retries reached. Failing.");
throw error;
}
}

/**
* Llama a la API de Gemini para generar contenido.
* @param {string} userPrompt El prompt del usuario.
* @param {string} systemPrompt (Opcional) La instrucción del sistema.
* @returns {Promise<string>} El texto generado.
*/
async function callGemini(userPrompt, systemPrompt = "") {
const apiKey = ""; // Dejado en blanco, como se indica en las instrucciones
const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

const payload = {
contents: [{ parts: [{ text: userPrompt }] }],
};

if (systemPrompt) {
payload.systemInstruction = {
parts: [{ text: systemPrompt }]
};
}

try {
const result = await fetchWithBackoff(apiUrl, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(payload)
});

const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
if (text) {
return text;
} else {
// console.warn("No text returned from Gemini:", result);
return "No se pudo generar el resumen.";
}
} catch (error) {
console.error("Error llamando a la API de Gemini:", error);
return "Error al contactar la IA.";
}
}

/**
* Genera un resumen inteligente para el chofer usando Gemini.
* @param {object} route Los datos de la ruta.
* @param {Array<object>} routeTrips Los viajes asignados a esa ruta.
* @returns {Promise<string>} Un resumen en HTML/texto.
*/
async function getGeminiDriverSummary(route, routeTrips) {
const systemPrompt = "Sos un asistente de logística para 'MG Transporte' en Argentina. Tu tono es amigable, profesional y usás 'vos' en lugar de 'tú'. Generá un resumen corto y útil para el chofer. NO uses markdown, solo texto plano y viñetas con '*' o '-'.";

const simplifiedTrips = routeTrips.map((trip, index) => ({
parada: index + 1,
cliente: trip.clientName,
hora: trip.time,
origen: `${trip.addressOrigin}, ${trip.localityOrigin}`,
destino: `${trip.addressDest}, ${trip.localityDest}`,
pasajeros: trip.pasajeros || 1,
mascotas: trip.mascotas || 0,
tamano_mascota: trip.petSize || 'ninguno'
}));

const userPrompt = `
Generá un resumen para el chofer ${route.driverName} para su ruta del ${route.date}.

Datos de la Ruta:
- Total de paradas: ${routeTrips.length}
- Ganancia Bruta Total: ${formatPrice(route.totalPrice)}
- Vehículo: ${route.vehicleModel} (${route.vehiclePlate})

Listado de Viajes (Tramos):
${JSON.stringify(simplifiedTrips, null, 2)}

Tu tarea es escribir un resumen amigable en 3-4 viñetas. Enfocate SÓLO en lo más importante.
Cosas a destacar (si existen):
- ¿Hay mascotas? ¿De qué tamaño? (¡Muy importante!)
- ¿Hay paradas que estén muy cerca en la misma localidad?
- ¿Hay algún viaje con muchos pasajeros?

Empezá con "¡Hola ${route.driverName}! Acá tenés un resumen rápido de tu ruta:"
`;

let summaryText = await callGemini(userPrompt, systemPrompt);

// Formatear el resumen a HTML simple
const summaryHtml = `
<div class="gemini-summary">
<p class="gemini-summary-title">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
Resumen del Chofer (IA)
</p>
${summaryText.replace(/\n/g, '<br>').replace(/\* /g, '&#8226; ').replace(/- /g, '&#8226; ')}
</div>
`;

// Texto plano para copiar
const summaryPlainText = summaryText
.replace(/<br>/g, '\n')
.replace(/&#8226;/g, '*');

return { html: summaryHtml, text: summaryPlainText };
}

// --- FIN SECCIÓN GEMINI ---


// --- LÓGICA DE VEHÍCULOS ---
document.getElementById('vehicle-form').addEventListener('submit', async (e) => {
e.preventDefault();
if (!userId) { showStatus('Error: Usuario no autenticado.', 'error'); return; }
const vehicleData = {
model: document.getElementById('vehicle-model').value.trim(),
color: document.getElementById('vehicle-color').value.trim(),
plate: document.getElementById('vehicle-plate').value.trim(),
createdAt: serverTimestamp()
};
try {
await addDoc(collection(db, VEHICLES_COLLECTION()), vehicleData);
showStatus(`Vehículo ${vehicleData.model} (${vehicleData.plate}) guardado.`);
document.getElementById('vehicle-form').reset();
} catch (error) {
console.error("Error al añadir vehículo:", error);
showStatus('Error al guardar el vehículo: ' + error.message, 'error');
}
});

function listenForVehicles() {
const q = collection(db, VEHICLES_COLLECTION());
onSnapshot(q, (snapshot) => {
vehiclesData = [];
const listEl = document.getElementById('vehicles-list');
const selectEl = document.getElementById('route-vehicle-id');
listEl.innerHTML = '';
selectEl.innerHTML = '<option value="">-- Seleccionar Vehículo --</option>';
if (document.getElementById('loading-vehicles')) {
document.getElementById('loading-vehicles').remove();
}
if (snapshot.empty) {
listEl.innerHTML = '<p class="text-center text-gray-500 p-4 border border-dashed rounded-lg">No hay vehículos registrados.</p>';
}
snapshot.docs.forEach(docSnapshot => {
const data = { id: docSnapshot.id, ...docSnapshot.data() };
vehiclesData.push(data);
listEl.innerHTML += `
<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border">
<div>
<p class="font-semibold text-gray-800">${data.model} (${data.plate})</p>
<p class="text-sm text-gray-500">Color: ${data.color}</p>
</div>
<button data-id="${data.id}" data-plate="${data.plate}" class="delete-vehicle-btn text-red-500 hover:text-red-700 p-1 rounded-full transition duration-150">
<i data-lucide="trash-2" class="w-5 h-5"></i>
</button>
</div>
`;
selectEl.innerHTML += `<option value="${data.id}">${data.model} (${data.plate})</option>`;
});
lucide.createIcons();
document.querySelectorAll('.delete-vehicle-btn').forEach(btn => {
btn.addEventListener('click', handleDeleteVehicle);
});
}, (error) => {
console.error("Error en el oyente de vehículos:", error);
listEl.innerHTML = 'Error al cargar vehículos.';
});
}

async function handleDeleteVehicle(e) {
const vehicleId = e.currentTarget.getAttribute('data-id');
const vehiclePlate = e.currentTarget.getAttribute('data-plate');
if (prompt(`¿Seguro que deseas eliminar el vehículo ${vehiclePlate}? Escribe 'eliminar' para confirmar.`) === 'eliminar') {
try {
await deleteDoc(doc(db, VEHICLES_COLLECTION(), vehicleId));
showStatus(`Vehículo ${vehiclePlate} eliminado.`);
} catch (error) {
console.error("Error al eliminar vehículo:", error);
showStatus('Error al eliminar vehículo: ' + error.message, 'error');
}
}
}

// --- LÓGICA DE CHOFERES ---
document.getElementById('driver-form').addEventListener('submit', async (e) => {
e.preventDefault();
if (!userId) { showStatus('Error: Usuario no autenticado.', 'error'); return; }
const driverData = {
name: document.getElementById('driver-name').value.trim(),
dni: document.getElementById('driver-dni').value.trim(),
phone: document.getElementById('driver-phone').value.trim(),
createdAt: serverTimestamp()
};
try {
await addDoc(collection(db, DRIVERS_COLLECTION()), driverData);
showStatus(`Chofer ${driverData.name} guardado.`);
document.getElementById('driver-form').reset();
} catch (error) {
console.error("Error al añadir chofer:", error);
showStatus('Error al guardar el chofer: ' + error.message, 'error');
}
});

function listenForDrivers() {
const q = collection(db, DRIVERS_COLLECTION());
onSnapshot(q, (snapshot) => {
driversData = [];
const listEl = document.getElementById('drivers-list');
const selectEl = document.getElementById('route-driver-id');
listEl.innerHTML = '';
selectEl.innerHTML = '<option value="">-- Seleccionar Chofer --</option>';
if (document.getElementById('loading-drivers')) {
document.getElementById('loading-drivers').remove();
}
if (snapshot.empty) {
listEl.innerHTML = '<p class="text-center text-gray-500 p-4 border border-dashed rounded-lg">No hay choferes registrados.</p>';
}
snapshot.docs.forEach(docSnapshot => {
const data = { id: docSnapshot.id, ...docSnapshot.data() };
driversData.push(data);
listEl.innerHTML += `
<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-l-4 border-primary">
<div>
<p class="font-semibold text-gray-800">${data.name}</p>
<p class="text-sm text-gray-500">DNI: ${data.dni} | Teléfono: ${data.phone}</p>
</div>
<button data-id="${data.id}" data-name="${data.name}" class="delete-driver-btn text-red-500 hover:text-red-700 p-1 rounded-full transition duration-150">
<i data-lucide="trash-2" class="w-5 h-5"></i>
</button>
</div>
`;
selectEl.innerHTML += `<option value="${data.id}">${data.name} (DNI: ${data.dni})</option>`;
});
lucide.createIcons();
document.querySelectorAll('.delete-driver-btn').forEach(btn => {
btn.addEventListener('click', handleDeleteDriver);
});
}, (error) => {
console.error("Error en oyente de choferes:", error);
listEl.innerHTML = 'Error al cargar choferes.';
});
}

async function handleDeleteDriver(e) {
const driverId = e.currentTarget.getAttribute('data-id');
const driverName = e.currentTarget.getAttribute('data-name');
if (prompt(`¿Seguro que deseas eliminar al chofer ${driverName}? Escribe 'eliminar' para confirmar.`) === 'eliminar') {
try {
await deleteDoc(doc(db, DRIVERS_COLLECTION(), driverId));
showStatus(`Chofer ${driverName} eliminado.`);
} catch (error) {
console.error("Error al eliminar chofer:", error);
showStatus('Error al eliminar chofer: ' + error.message, 'error');
}
}
}


// --- LÓGICA DE VIAJES (Tickets) ---

// Manejador del formulario (Crear y Editar)
document.getElementById('trip-form').addEventListener('submit', async (e) => {
e.preventDefault();
if (!userId) { showStatus('Error: Usuario no autenticado.', 'error'); return; }

const tripData = {
clientName: document.getElementById('client-name').value.trim(),
clientPhone: document.getElementById('client-phone').value.trim(),
addressOrigin: document.getElementById('address-origin').value.trim(),
localityOrigin: document.getElementById('locality-origin').value.trim(),
addressDest: document.getElementById('address-dest').value.trim(),
localityDest: document.getElementById('locality-dest').value.trim(),
date: document.getElementById('trip-date').value,
time: document.getElementById('trip-time').value,
price: parseFloat(document.getElementById('trip-price').value),
pasajeros: parseInt(document.getElementById('trip-passengers').value, 10),
mascotas: parseInt(document.getElementById('trip-pets').value, 10),
petSize: document.getElementById('trip-pet-size').value,
};

try {
if (currentlyEditingTripId) {
// Actualizar Viaje Existente
const tripRef = doc(db, TRIPS_COLLECTION(), currentlyEditingTripId);
await updateDoc(tripRef, tripData);
showStatus(`Ticket de ${tripData.clientName} actualizado.`, 'success');
} else {
// Crear Nuevo Viaje
tripData.isAssigned = false;
tripData.assignedRouteId = null;
tripData.status = 'Activo'; // Nuevo campo de estado
tripData.createdAt = serverTimestamp();
tripData.ticketId = Math.random().toString(36).substring(2, 9).toUpperCase();

await addDoc(collection(db, TRIPS_COLLECTION()), tripData);
showStatus(`Ticket #${tripData.ticketId} para ${tripData.clientName} registrado.`, 'success');
// Mostrar modal solo al crear, ahora es async
await showClientTicketModal(tripData, e.currentTarget);
}
handleCancelEdit(); // Limpia el formulario y el estado de edición
} catch (error) {
console.error("Error al guardar viaje:", error);
showStatus('Error al guardar el viaje: ' + error.message, 'error');
}
});

// Botón Cancelar Edición
document.getElementById('cancel-edit-btn').addEventListener('click', handleCancelEdit);

function handleCancelEdit() {
currentlyEditingTripId = null;
document.getElementById('trip-form').reset();
document.getElementById('editing-trip-id').value = '';
document.getElementById('save-trip-btn').innerHTML = '<i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Registrar Ticket';
document.getElementById('cancel-edit-btn').classList.add('hidden');
lucide.createIcons();
}

// Iniciar edición
function handleStartEditTrip(e) {
const tripData = JSON.parse(e.currentTarget.getAttribute('data-trip'));
window.scrollTo(0, 0); // Subir al formulario

currentlyEditingTripId = tripData.id;
document.getElementById('editing-trip-id').value = tripData.id;
document.getElementById('client-name').value = tripData.clientName;
document.getElementById('client-phone').value = tripData.clientPhone;
document.getElementById('address-origin').value = tripData.addressOrigin;
document.getElementById('locality-origin').value = tripData.localityOrigin;
document.getElementById('address-dest').value = tripData.addressDest;
document.getElementById('locality-dest').value = tripData.localityDest;
document.getElementById('trip-date').value = tripData.date;
document.getElementById('trip-time').value = tripData.time;
document.getElementById('trip-price').value = tripData.price;
document.getElementById('trip-passengers').value = tripData.pasajeros || 1;
document.getElementById('trip-pets').value = tripData.mascotas || 0;
document.getElementById('trip-pet-size').value = tripData.petSize || 'ninguno';

document.getElementById('save-trip-btn').innerHTML = '<i data-lucide="save" class="w-5 h-5 mr-2"></i> Guardar Cambios';
document.getElementById('cancel-edit-btn').classList.remove('hidden');
lucide.createIcons();
}

// Finalizar viaje
async function handleFinalizeTrip(e) {
const tripId = e.currentTarget.getAttribute('data-id');
const clientName = e.currentTarget.getAttribute('data-client');
if (prompt(`¿Seguro que deseas finalizar el viaje de ${clientName}? El ticket se moverá a 'Finalizados'. Escribe 'finalizar' para confirmar.`) === 'finalizar') {
try {
const tripRef = doc(db, TRIPS_COLLECTION(), tripId);
await updateDoc(tripRef, { status: 'Finalizado' });
showStatus(`Viaje de ${clientName} finalizado.`);
} catch (error) {
console.error("Error al finalizar viaje:", error);
showStatus('Error al finalizar viaje: ' + error.message, 'error');
}
}
}

// Escuchar todos los viajes
function listenForTrips() {
const q = collection(db, TRIPS_COLLECTION());
onSnapshot(q, (snapshot) => {
allTripsData = snapshot.docs.map(docSnapshot => ({ id: docSnapshot.id, ...docSnapshot.data() }));
renderTripLists(allTripsData); // Renderizar en ambas listas
renderPendingTripsList(); // Actualizar lista en pestaña Rutas
}, (error) => {
console.error("Error en oyente de viajes:", error);
document.getElementById('trips-list-active').innerHTML = 'Error al cargar tickets.';
});
}

// Renderiza las listas de Activos y Finalizados
function renderTripLists(trips) {
const activeListEl = document.getElementById('trips-list-active');
const finishedListEl = document.getElementById('trips-list-finished');
activeListEl.innerHTML = '';
finishedListEl.innerHTML = '';

const activeTrips = trips.filter(t => t.status !== 'Finalizado').sort((a, b) => `${a.date} ${a.time}`.localeCompare(`${b.date} ${b.time}`));
const finishedTrips = trips.filter(t => t.status === 'Finalizado').sort((a, b) => `${a.date} ${a.time}`.localeCompare(`${b.date} ${b.time}`));

// Renderizar Activos
if (document.getElementById('loading-trips-active')) document.getElementById('loading-trips-active').remove();
if (activeTrips.length === 0) {
activeListEl.innerHTML = '<p class="text-center text-gray-500 p-4 border border-dashed rounded-lg">No hay tickets activos.</p>';
} else {
activeTrips.forEach(data => activeListEl.innerHTML += createTripCardHtml(data, 'active'));
}

// Renderizar Finalizados
if (document.getElementById('loading-trips-finished')) document.getElementById('loading-trips-finished').remove();
if (finishedTrips.length === 0) {
finishedListEl.innerHTML = '<p class="text-center text-gray-500 p-4 border border-dashed rounded-lg">No hay tickets finalizados.</p>';
} else {
finishedTrips.forEach(data => finishedListEl.innerHTML += createTripCardHtml(data, 'finished'));
}

lucide.createIcons();
setupTripCardButtons();
}

// HTML para una tarjeta de viaje
function createTripCardHtml(data, type) {
const assignedText = data.isAssigned ?
`<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-xs">Asignado a Ruta #${data.assignedRouteId.slice(-4)}</span>` :
`<span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full text-xs">Pendiente de Ruta</span>`;

let petInfo = `Mascotas: ${data.mascotas || 0}`;
if (data.petSize && data.petSize !== 'ninguno') {
petInfo += ` (${data.petSize})`;
}

let buttons = '';
if (type === 'active') {
buttons = `
<button data-trip='${JSON.stringify(data)}' class="edit-trip-btn text-blue-600 hover:text-blue-800 text-xs font-medium mr-2 p-1 rounded-lg bg-blue-100">
<i data-lucide="edit-2" class="w-4 h-4"></i> Editar
</button>
<button data-id="${data.id}" data-client="${data.clientName}" class="finalize-trip-btn text-green-600 hover:text-green-800 text-xs font-medium mr-2 p-1 rounded-lg bg-green-100">
<i data-lucide="check-circle" class="w-4 h-4"></i> Finalizar
</button>
<button data-id="${data.id}" data-client="${data.clientName}" class="delete-trip-btn text-red-500 hover:text-red-700 text-xs font-medium p-1 rounded-lg bg-red-100">
<i data-lucide="trash-2" class="w-4 h-4"></i> Borrar
</button>
`;
} else {
buttons = `
<button data-id="${data.id}" data-client="${data.clientName}" class="delete-trip-btn text-red-500 hover:text-red-700 text-xs font-medium p-1 rounded-lg bg-red-100">
<i data-lucide="trash-2" class="w-4 h-4"></i> Borrar
</button>
`;
}

return `
<div class="bg-gray-50 p-4 border rounded-xl shadow-sm border-l-4 ${data.isAssigned ? 'border-green-500' : 'border-red-500'}">
<div class="flex justify-between items-start mb-2">
<h3 class="font-bold text-lg text-gray-700">${data.clientName}</h3>
<div class="text-right">
<span class="text-xs font-mono bg-gray-200 text-gray-600 px-2 py-1 rounded-full">#${data.ticketId}</span>
${type === 'active' ? assignedText : '<span class="bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full text-xs">Finalizado</span>'}
</div>
</div>
<p class="text-sm text-gray-500 mb-2">
<i data-lucide="map-pin" class="w-4 h-4 inline-block mr-1 text-red-500"></i> ${data.addressOrigin}, ${data.localityOrigin}
<i data-lucide="arrow-right" class="w-4 h-4 inline-block mx-2"></i>
<i data-lucide="flag" class="w-4 h-4 inline-block mr-1 text-green-500"></i> ${data.addressDest}, ${data.localityDest}
</p>
<p class="text-sm text-gray-500 mb-2">
<i data-lucide="clock" class="w-4 h-4 inline-block mr-1 text-blue-500"></i> ${data.date} a las ${data.time}
</p>
<p class="text-sm text-gray-500 mb-2">
<i data-lucide="users" class="w-4 h-4 inline-block mr-1 text-blue-500"></i> Pasajeros: ${data.pasajeros || 1} |
<i data-lucide="dog" class="w-4 h-4 inline-block ml-3 mr-1 text-blue-500"></i> ${petInfo}
</p>
<div class="flex justify-between items-center pt-2 border-t border-gray-200">
<span class="font-bold text-green-600">${formatPrice(data.price)}</span>
<div class="flex items-center">
<button data-trip='${JSON.stringify(data)}' class="generate-client-ticket-btn text-primary hover:underline text-sm font-medium mr-4 transition-all duration-150">
Ver Ticket
</button>
<div class="flex gap-2">
${buttons}
</div>
</div>
</div>
</div>
`;
}

// Configura los botones de las tarjetas
function setupTripCardButtons() {
document.querySelectorAll('.generate-client-ticket-btn').forEach(btn => {
btn.addEventListener('click', async (e) => { // <-- Ahora es async
const button = e.currentTarget;
const originalText = button.innerHTML;
button.innerHTML = 'Generando...';
button.disabled = true;
try {
const tripData = JSON.parse(button.getAttribute('data-trip'));
await showClientTicketModal(tripData); // <-- Ahora se espera
} catch (error) {
console.error("Error al generar ticket:", error);
showStatus("Error al generar resumen de IA.", "error");
} finally {
button.innerHTML = originalText;
button.disabled = false;
}
});
});
document.querySelectorAll('.delete-trip-btn').forEach(btn => {
btn.addEventListener('click', handleDeleteTrip);
});
document.querySelectorAll('.edit-trip-btn').forEach(btn => {
btn.addEventListener('click', handleStartEditTrip);
});
document.querySelectorAll('.finalize-trip-btn').forEach(btn => {
btn.addEventListener('click', handleFinalizeTrip);
});
}

// Borrar viaje
async function handleDeleteTrip(e) {
const tripId = e.currentTarget.getAttribute('data-id');
const clientName = e.currentTarget.getAttribute('data-client');
const trip = allTripsData.find(t => t.id === tripId);
let confirmMsg = `¿Seguro que deseas eliminar el viaje de ${clientName}? Esta acción es permanente.`;
if (trip && trip.isAssigned) {
confirmMsg = `ADVERTENCIA: Este ticket está asignado a una ruta. ¿Estás seguro de que quieres eliminarlo? Deberás desasignarlo manualmente de la ruta.\n\nEscribe 'eliminar' para confirmar.`;
} else {
confirmMsg = `¿Seguro que deseas eliminar el viaje de ${clientName}? Escribe 'eliminar' para confirmar.`;
}
if (prompt(confirmMsg) === 'eliminar') {
try {
await deleteDoc(doc(db, TRIPS_COLLECTION(), tripId));
showStatus(`Viaje de ${clientName} eliminado.`, 'success');
} catch (error) {
console.error("Error al eliminar viaje:", error);
showStatus('Error al eliminar viaje: ' + error.message, 'error');
}
}
}


// --- LÓGICA DE RUTAS (Asignación) ---
function setupRouteAssignmentLogic() {
document.getElementById('route-form').addEventListener('submit', handleCreateRoute);
// El click handler ahora es async
document.getElementById('view-route-ticket-btn').addEventListener('click', handleViewRouteTicket);
document.getElementById('finalize-route-btn').addEventListener('click', handleFinalizeRoute);
}

function listenForRoutes() {
const q = collection(db, ROUTES_COLLECTION());
onSnapshot(q, (snapshot) => {
allRoutesData = snapshot.docs.map(docSnapshot => ({ id: docSnapshot.id, ...docSnapshot.data() }));
renderActiveRoutesList(allRoutesData);
if (currentRouteData) {
const updatedRoute = allRoutesData.find(r => r.id === currentRouteData.id);
if (updatedRoute) {
currentRouteData = updatedRoute;
updateRouteDetails(updatedRoute);
} else {
currentRouteData = null;
updateRouteDetails(null);
}
}
}, (error) => {
console.error("Error en oyente de rutas:", error);
document.getElementById('active-routes-list').innerHTML = 'Error al cargar rutas.';
});
}

async function handleCreateRoute(e) {
e.preventDefault();
if (!userId) { showStatus('Error: Usuario no autenticado.', 'error'); return; }
const driverId = document.getElementById('route-driver-id').value;
const vehicleId = document.getElementById('route-vehicle-id').value;
const date = document.getElementById('route-date').value;
const driver = driversData.find(d => d.id === driverId);
const vehicle = vehiclesData.find(v => v.id === vehicleId);
if (!driver || !vehicle) {
showStatus('Debe seleccionar un chofer y un vehículo válidos.', 'error');
return;
}
const newRoute = {
driverId, driverName: driver.name, driverDni: driver.dni, driverPhone: driver.phone,
vehicleId, vehiclePlate: vehicle.plate, vehicleModel: vehicle.model, vehicleColor: vehicle.color,
date, trips: [], totalPrice: 0, status: 'Activa', createdAt: serverTimestamp()
};
try {
const docRef = await addDoc(collection(db, ROUTES_COLLECTION()), newRoute);
showStatus(`Ruta #${docRef.id.slice(-4)} creada para ${driver.name}.`, 'success');
document.getElementById('route-form').reset();
} catch (error) {
console.error("Error al crear ruta:", error);
showStatus('Error al crear ruta: ' + error.message, 'error');
}
}

function renderActiveRoutesList(routes) {
const listEl = document.getElementById('active-routes-list');
listEl.innerHTML = '';
if (document.getElementById('loading-routes')) document.getElementById('loading-routes').remove();
const activeRoutes = routes.filter(r => r.status === 'Activa');
if (activeRoutes.length === 0) {
listEl.innerHTML = '<p class="text-center text-gray-500 text-sm p-3 border border-dashed rounded-lg">No hay rutas activas.</p>';
return;
}
activeRoutes.forEach(route => {
const tripCount = route.trips.length;
const total = formatPrice(route.totalPrice);
listEl.innerHTML += `
<div data-id="${route.id}" class="route-select-card cursor-pointer p-3 bg-gray-50 rounded-lg shadow-sm border route-status-card hover:bg-yellow-50 transition duration-150">
<div class="flex justify-between items-center">
<p class="font-semibold text-gray-800">Ruta #${route.id.slice(-4)} (${route.date})</p>
<span class="text-xs font-medium text-primary">${total}</span>
</div>
<p class="text-sm text-gray-600">Chofer: ${route.driverName}</p>
<p class="text-xs text-gray-500">${tripCount} Tramo(s) asignado(s)</p>
</div>
`;
});
document.querySelectorAll('.route-select-card').forEach(card => {
card.addEventListener('click', (e) => {
const routeId = e.currentTarget.getAttribute('data-id');
currentRouteData = allRoutesData.find(r => r.id === routeId);
updateRouteDetails(currentRouteData);
document.querySelectorAll('.route-select-card').forEach(c => c.classList.remove('bg-yellow-100', 'border-yellow-400'));
e.currentTarget.classList.add('bg-yellow-100', 'border-yellow-400');
});
});
}

// FIX: Añadir comprobaciones de nulidad
function updateRouteDetails(route) {
const infoEl = document.getElementById('route-details-info');
const assignedTripsEl = document.getElementById('assigned-trips-list');
const totalEl = document.getElementById('route-total-price');
const ticketBtn = document.getElementById('view-route-ticket-btn');
const finalizeBtn = document.getElementById('finalize-route-btn');
const routeIdDisplayEl = document.getElementById('route-id-display');
const driverDetailsEl = document.getElementById('route-driver-details');
const vehicleDetailsEl = document.getElementById('route-vehicle-details');
const dateDetailsEl = document.getElementById('route-date-details');

if (!route) {
if (routeIdDisplayEl) routeIdDisplayEl.textContent = '';
if (infoEl) infoEl.innerHTML = '<p class="text-center text-gray-500">Selecciona una ruta activa para ver sus detalles.</p>';
if (assignedTripsEl) assignedTripsEl.innerHTML = '<p class="text-center text-gray-500 text-sm">Selecciona una ruta activa para ver los viajes asignados.</p>';
if (totalEl) totalEl.textContent = '';
if (ticketBtn) ticketBtn.disabled = true;
if (finalizeBtn) finalizeBtn.disabled = true;
return;
}

if (routeIdDisplayEl) routeIdDisplayEl.textContent = `#${route.id.slice(-4)}`;
if (driverDetailsEl) driverDetailsEl.innerHTML = `<i data-lucide="user-check" class="w-4 h-4 inline-block mr-1 text-primary"></i> Chofer: ${route.driverName} (Tel: ${route.driverPhone})`;
if (vehicleDetailsEl) vehicleDetailsEl.innerHTML = `<i data-lucide="car-front" class="w-4 h-4 inline-block mr-1 text-accent"></i> Vehículo: ${route.vehicleModel} (${route.vehiclePlate})`;
if (dateDetailsEl) dateDetailsEl.innerHTML = `<i data-lucide="calendar" class="w-4 h-4 inline-block mr-1 text-gray-500"></i> Fecha: ${route.date}`;
if (totalEl) totalEl.textContent = `Total Bruto de Ruta: ${formatPrice(route.totalPrice)}`;

if (ticketBtn) {
ticketBtn.disabled = route.trips.length === 0;
ticketBtn.setAttribute('data-route', JSON.stringify(route));
}
if (finalizeBtn) {
finalizeBtn.disabled = false;
finalizeBtn.setAttribute('data-id', route.id);
}

if (assignedTripsEl) {
assignedTripsEl.innerHTML = '';
if (route.trips.length === 0) {
assignedTripsEl.innerHTML = '<p class="text-center text-gray-500 text-sm p-4 border border-dashed rounded-lg">Aún no hay tickets asignados a esta ruta.</p>';
} else {
const assignedTrips = allTripsData.filter(t => route.trips.includes(t.id));
assignedTrips.sort((a, b) => a.time.localeCompare(b.time));
assignedTrips.forEach(trip => {
let petInfo = `Pasajeros: ${trip.pasajeros || 1} | Mascotas: ${trip.mascotas || 0}`;
if (trip.petSize && trip.petSize !== 'ninguno') {
petInfo += ` (${trip.petSize})`;
}
assignedTripsEl.innerHTML += `
<div class="p-3 bg-blue-50 border rounded-lg border-blue-200">
<div class="flex justify-between items-start">
<p class="font-semibold text-sm text-blue-700">#${trip.ticketId} - ${trip.clientName}</p>
<button data-trip-id="${trip.id}" data-route-id="${route.id}" class="remove-trip-from-route-btn text-red-500 hover:text-red-700 transition duration-150">
<i data-lucide="x" class="w-4 h-4"></i>
</button>
</div>
<p class="text-xs text-gray-600">${trip.time} | De: ${trip.localityOrigin} a: ${trip.localityDest}</p>
<p class="text-xs text-gray-600">${petInfo}</p>
<span class="text-xs font-bold text-green-600">${formatPrice(trip.price)}</span>
</div>
`;
});
}
}

renderPendingTripsList();
lucide.createIcons();

if (assignedTripsEl) {
assignedTripsEl.querySelectorAll('.remove-trip-from-route-btn').forEach(btn => {
btn.addEventListener('click', handleRemoveTripFromRoute);
});
}
}


function renderPendingTripsList() {
const listEl = document.getElementById('pending-trips-list');
if (!listEl) return; // FIX: Salir si el elemento no existe

listEl.innerHTML = '';
if (document.getElementById('loading-pending-trips')) document.getElementById('loading-pending-trips').remove();
const availableTrips = allTripsData.filter(t => !t.isAssigned && t.status === 'Activo');
if (availableTrips.length === 0) {
listEl.innerHTML = '<p class="text-center text-gray-500 text-sm p-3 border border-dashed rounded-lg">No hay tickets pendientes de asignación.</p>';
return;
}
availableTrips.sort((a, b) => a.time.localeCompare(b.time));
availableTrips.forEach(trip => {
let petInfo = `Pasajeros: ${trip.pasajeros || 1} | Mascotas: ${trip.mascotas || 0}`;
if (trip.petSize && trip.petSize !== 'ninguno') {
petInfo += ` (${trip.petSize})`;
}
listEl.innerHTML += `
<div class="p-3 bg-gray-50 border rounded-lg border-gray-200">
<div class="flex justify-between items-center">
<div>
<p class="font-semibold text-sm text-gray-700">${trip.clientName}</p>
<p class="text-xs text-gray-500">${trip.time} | De: ${trip.localityOrigin} a: ${trip.localityDest}</p>
<p class="text-xs text-gray-500">${petInfo}</p>
</div>
<button data-trip-id="${trip.id}" class="assign-trip-to-route-btn bg-green-500 text-white text-xs font-medium py-1 px-3 rounded-lg hover:bg-green-600 transition duration-150" ${currentRouteData ? '' : 'disabled'}>
<i data-lucide="plus" class="w-4 h-4 inline-block mr-1"></i> Añadir
</button>
</div>
</div>
`;
});
lucide.createIcons();
document.querySelectorAll('.assign-trip-to-route-btn').forEach(btn => {
btn.addEventListener('click', handleAssignTripToRoute);
});
}

async function handleAssignTripToRoute(e) {
if (!currentRouteData) { showStatus('Debe seleccionar una ruta activa primero.', 'error'); return; }
const tripId = e.currentTarget.getAttribute('data-trip-id');
const trip = allTripsData.find(t => t.id === tripId);
if (!trip) return;
const newTripsArray = [...currentRouteData.trips, tripId];
const newTotalPrice = (currentRouteData.totalPrice || 0) + (trip.price || 0);
try {
await updateDoc(doc(db, ROUTES_COLLECTION(), currentRouteData.id), {
trips: newTripsArray,
totalPrice: newTotalPrice
});
await updateDoc(doc(db, TRIPS_COLLECTION(), tripId), {
isAssigned: true,
assignedRouteId: currentRouteData.id
});
showStatus(`Ticket ${trip.ticketId} asignado a Ruta #${currentRouteData.id.slice(-4)}`, 'success');
} catch (error) {
console.error("Error al asignar viaje a ruta:", error);
showStatus('Error al asignar viaje a ruta: ' + error.message, 'error');
}
}

async function handleRemoveTripFromRoute(e) {
if (!currentRouteData) { return; }
const tripId = e.currentTarget.getAttribute('data-trip-id');
const routeId = e.currentTarget.getAttribute('data-route-id');
const trip = allTripsData.find(t => t.id === tripId);
if (!trip || trip.assignedRouteId !== routeId) return;
const newTripsArray = currentRouteData.trips.filter(id => id !== tripId);
const newTotalPrice = (currentRouteData.totalPrice || 0) - (trip.price || 0);
if (prompt(`¿Seguro que deseas desasignar el viaje de ${trip.clientName} de la ruta #${routeId.slice(-4)}? El ticket volverá a estar pendiente. Escribe 'desasignar' para confirmar.`) === 'desasignar') {
try {
await updateDoc(doc(db, ROUTES_COLLECTION(), routeId), {
trips: newTripsArray,
totalPrice: newTotalPrice
});
await updateDoc(doc(db, TRIPS_COLLECTION(), tripId), {
isAssigned: false,
assignedRouteId: null
});
showStatus(`Ticket ${trip.ticketId} desasignado y marcado como pendiente.`, 'success');
} catch (error) {
console.error("Error al desasignar viaje:", error);
showStatus('Error al desasignar viaje: ' + error.message, 'error');
}
}
}

async function handleFinalizeRoute(e) {
if (!currentRouteData) { showStatus('Selecciona una ruta para finalizar.', 'error'); return; }
if (prompt(`¿Quieres finalizar la Ruta #${currentRouteData.id.slice(-4)}? Esta acción es irreversible. Escribe 'finalizar' para confirmar.`) === 'finalizar') {
try {
const routeId = currentRouteData.id;
await updateDoc(doc(db, ROUTES_COLLECTION(), routeId), {
status: 'Finalizada',
finishedAt: serverTimestamp()
});
currentRouteData = null;
updateRouteDetails(null);
showStatus(`Ruta #${routeId.slice(-4)} finalizada con éxito.`, 'success');
} catch (error) {
console.error("Error al finalizar ruta:", error);
showStatus('Error al finalizar ruta: ' + error.message, 'error');
}
}
}


// --- LÓGICA DEL MODAL DE TICKET (MEJORADO CON GEMINI) ---

/**
* Genera el ticket para el chofer (basado en la RUTA COMPLETA)
* @param {object} route Los datos de la ruta.
* @param {object} geminiSummary Un objeto {html, text} del resumen de Gemini.
*/
function generateRouteTicket(route, geminiSummary) {
const routeTrips = allTripsData.filter(t => route.trips.includes(t.id));
routeTrips.sort((a, b) => a.time.localeCompare(b.time));

let routeDetailsText = '';
let routeDetailsHtml = '';

routeTrips.forEach((trip, index) => {
let petInfoText = `Pasajeros: ${trip.pasajeros || 1} | Mascotas: ${trip.mascotas || 0}`;
if (trip.petSize && trip.petSize !== 'ninguno') {
petInfoText += ` (${trip.petSize})`;
}

routeDetailsText += `
*TRAMO ${index + 1}* (Boleto #${trip.ticketId})
Cliente: ${trip.clientName} (Tel: ${trip.clientPhone || 'N/A'})
${petInfoText}
- Recogida (Hora Aprox.): ${trip.time}
- Origen: ${trip.addressOrigin}, ${trip.localityOrigin}
- Destino: ${trip.addressDest}, ${trip.localityDest}
- Precio Cliente: ${formatPrice(trip.price)}
------------------------------------
`;

routeDetailsHtml += `
<div class="border-t border-gray-200 pt-3 mt-3">
<p class="section-title">TRAMO ${index + 1} (Boleto #${trip.ticketId})</p>
<p><strong>Cliente:</strong> ${trip.clientName} (Tel: ${trip.clientPhone || 'N/A'})</p>
<p><strong>Info:</strong> ${petInfoText}</p>
<p><strong>Recogida (Aprox):</strong> ${trip.time}</p>
<p><strong>Origen:</strong> ${trip.addressOrigin}, ${trip.localityOrigin}</p>
<p><strong>Destino:</strong> ${trip.addressDest}, ${trip.localityDest}</p>
<p class="highlight">Precio Cliente: ${formatPrice(trip.price)}</p>
</div>
`;
});

const text = `
*MG Transporte - TICKET DE RUTA #${route.id.slice(-4)}* (FECHA: ${route.date})

*DATOS DEL CHOFER Y VEHÍCULO*
- *Chofer:* ${route.driverName} (DNI: ${route.driverDni})
- *Teléfono Chofer:* ${route.driverPhone}
- *Vehículo:* ${route.vehicleModel} ${route.vehicleColor}
- *Patente:* ${route.vehiclePlate}

*✨ RESUMEN DE RUTA (IA) ✨*
${geminiSummary.text}
------------------------------------

*PUNTOS DE RECOGIDA Y DESTINO (Ordenado por Hora)*
${routeDetailsText}

*TOTAL BRUTO DE RUTA:* ${formatPrice(route.totalPrice)}
¡Buena ruta!
`.trim();

const html = `
<div class="printable-ticket">
<h4><i data-lucide="route" class="icon"></i>TICKET DE RUTA #${route.id.slice(-4)}</h4>
<p class="section-title">Chofer y Vehículo (Fecha: ${route.date})</p>
<p><strong>Chofer:</strong> ${route.driverName} (DNI: ${route.driverDni})</p>
<p><strong>Teléfono Chofer:</strong> ${route.driverPhone}</p>
<p><strong>Vehículo:</strong> ${route.vehicleModel} ${route.vehicleColor} (${route.vehiclePlate})</p

