<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MG Transporte ‚Äî Simplificado y funcional</title>

<!-- Tailwind (CDN, deferred) -->
<script defer src="https://cdn.tailwindcss.com"></script>

<!-- Google font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- SortableJS -->
<script defer src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<!-- jsPDF -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- SheetJS -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase (compat optional) -->
<script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
  :root{ --accent:#7c3aed; --accent2:#06b6d4; --bg-dark:#071026; --card-dark:rgba(255,255,255,0.03); --muted:#9fb1c8; }
  [data-theme="dark"]{ background:var(--bg-dark); color:#e8f1fb; }
  [data-theme="light"]{ background:#f6f9fc; color:#081028; --card-dark:#fff; --muted:#6b7280; }
  body{ font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; min-height:100vh; }
  .app{ display:flex; gap:16px; padding:16px; box-sizing:border-box; }
  .sidebar{ width:260px; border-radius:12px; padding:14px; background:var(--card-dark); }
  .logo{ height:48px; width:48px; border-radius:10px; background:linear-gradient(135deg,var(--accent),var(--accent2)); color:white; display:flex;align-items:center;justify-content:center;font-weight:800; }
  .nav button{ width:100%; text-align:left; padding:10px; border-radius:8px; display:flex; gap:8px; align-items:center; background:transparent; border:none; cursor:pointer; }
  .nav button.active{ background:linear-gradient(90deg, rgba(124,58,237,0.08), rgba(6,182,212,0.04)); }
  .main{ flex:1; display:flex; flex-direction:column; gap:12px; }
  .topbar{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .card{ background:var(--card-dark); border-radius:12px; padding:12px; }
  #mapPlanner{ height:320px; border-radius:10px; background:white; overflow:hidden; }
  table{ width:100%; border-collapse:collapse; }
  th,td{ padding:8px; text-align:left; font-size:14px; }
  .muted{ color:var(--muted); font-size:13px; }
  .btn{ padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; border:none; }
  .btn-primary{ background:linear-gradient(90deg,var(--accent),var(--accent2)); color:white; }
  .status{ padding:6px 8px; border-radius:8px; font-weight:700; display:inline-block; }
  .status-pend{ background:#f59e0b; color:#051622; } .status-asig{ background:#10b981; color:white; } .status-fin{ background:#6b7280; color:white; }
  @media (max-width:1000px){ .app{ flex-direction:column; } .sidebar{ width:100%; order:2 } .main{ order:1 } }
</style>
</head>
<body data-theme="dark">
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;">
        <div class="logo">MG</div>
        <div>
          <div style="font-weight:800;">MG Transporte</div>
          <div class="muted" style="font-size:12px;">Panel simplificado</div>
        </div>
      </div>

      <nav class="nav" id="nav">
        <button class="active" data-page="page-trips">‚úö Viajes</button>
        <button data-page="page-plan">üó∫ Planificar</button>
        <button data-page="page-clients">üë• Clientes</button>
        <button data-page="page-drivers">üöó Choferes</button>
        <button data-page="page-vehicles">üîß Veh√≠culos</button>
        <button data-page="page-tickets">‚úâÔ∏è Tickets</button>
        <button data-page="page-settings">‚öôÔ∏è Ajustes</button>
      </nav>

      <div style="margin-top:12px" class="muted">
        <div>Estado: <span id="syncStatus">Local</span></div>
        <div>Backups: <span id="backupCount">0</span></div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div>
          <h2 id="pageTitle">Viajes</h2>
          <div class="muted" id="pageSub">Crear y listar viajes</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;">
          <button id="themeToggle" class="btn btn-primary">Tema</button>
          <button id="btnExportPlan" class="btn">üìë Planilla Excel</button>
          <button id="btnExportJSON" class="btn">Exportar JSON</button>
          <button id="btnImportJSON" class="btn">Importar</button>
        </div>
      </div>

      <!-- PAGES -->
      <section id="page-trips" class="card page">
        <div style="display:flex;gap:12px;flex-wrap:wrap;">
          <!-- Form -->
          <div style="flex:1;min-width:300px;">
            <h3>Agregar / Editar viaje</h3>
            <div class="muted">Campos obligatorios (*)</div>
            <div style="margin-top:8px; display:grid; grid-template-columns:1fr 1fr; gap:8px;">
              <div><label class="muted">* Cliente</label><input id="inClient" class="w-full p-2 rounded" /></div>
              <div><label class="muted">* Tel√©fono</label><input id="inPhone" class="w-full p-2 rounded" /></div>
              <div><label class="muted">* Origen (direcci√≥n)</label><input id="inOrigin" class="w-full p-2 rounded" /></div>
              <div><label class="muted">Localidad origen</label><input id="inOriginLocal" class="w-full p-2 rounded" /></div>
              <div><label class="muted">* Destino</label><input id="inDest" class="w-full p-2 rounded" /></div>
              <div><label class="muted">Localidad destino</label><input id="inDestLocal" class="w-full p-2 rounded" /></div>
              <div><label class="muted">* Fecha</label><input id="inDate" type="date" class="w-full p-2 rounded" /></div>
              <div><label class="muted">* Hora</label><input id="inTime" type="time" class="w-full p-2 rounded" /></div>
              <div><label class="muted">* Precio</label><input id="inPrice" type="number" min="0" step="0.01" class="w-full p-2 rounded" /></div>
              <div><label class="muted">Pasajeros</label><input id="inPax" type="number" min="1" value="1" class="w-full p-2 rounded" /></div>
              <div><label class="muted">Mascota</label>
                <select id="inPet" class="w-full p-2 rounded"><option value="none">Ninguna</option><option value="small">&lt;5kg</option><option value="large">&gt;5kg</option></select>
              </div>
              <div><label class="muted">Menores</label><select id="inMinors" class="w-full p-2 rounded"><option value="no">No</option><option value="si">S√≠</option></select></div>

              <div style="grid-column:1/-1"><label class="muted">Servicio</label>
                <select id="inService" class="w-full p-2 rounded"><option value="compartido">Compartido</option><option value="exclusivo">Exclusivo</option></select>
              </div>

              <div style="grid-column:1/-1"><label class="muted">Observaciones</label><textarea id="inNotes" rows="3" class="w-full p-2 rounded"></textarea></div>
            </div>

            <div style="display:flex;gap:8px;margin-top:10px;">
              <button id="btnSaveTrip" class="btn btn-primary">Guardar</button>
              <button id="btnResetForm" class="btn">Limpiar</button>
              <div style="flex:1"></div>
              <div class="muted">Modo: <span id="formMode">Nuevo</span></div>
            </div>
          </div>

          <!-- List -->
          <div style="flex:1;min-width:420px;">
            <h3>Lista de viajes</h3>
            <div style="display:flex;gap:8px;margin-top:8px;">
              <input id="qTrips" placeholder="Buscar..." class="w-full p-2 rounded" />
              <select id="filterState" class="p-2 rounded"><option value="all">Todos</option><option value="Activo">Pendiente</option><option value="Asignado">Asignado</option><option value="Finalizado">Finalizado</option></select>
            </div>

            <div style="max-height:420px;overflow:auto;margin-top:8px;">
              <table><thead><tr><th>Cliente</th><th>Origen‚ÜíDestino</th><th>Fecha/Hora</th><th>Precio</th><th>Estado</th><th>Acciones</th></tr></thead>
                <tbody id="tbodyTrips"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- PLAN -->
      <section id="page-plan" class="card page hidden">
        <div style="display:flex;gap:12px;">
          <div style="width:320px;">
            <h3>Viajes sin asignar</h3>
            <div class="muted">Ordenados por fecha/hora ‚Äî arrastr√° al builder</div>
            <div style="margin-top:8px;"><button id="btnOptimize" class="btn">Optimizar (hora)</button></div>
            <div id="pendingList" style="max-height:520px; overflow:auto; margin-top:8px;"></div>
          </div>

          <div style="flex:1;">
            <h3>Mapa</h3>
            <div id="mapPlanner"></div>
            <div class="muted" style="margin-top:6px">Geocoding: Nominatim (OpenStreetMap)</div>
          </div>

          <div style="width:380px;">
            <h3>Ruta en construcci√≥n</h3>
            <div style="display:flex;gap:8px;">
              <select id="selDriver" class="w-full p-2 rounded"></select>
              <select id="selVehicle" class="w-full p-2 rounded"></select>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px;">
              <input id="selRouteDate" type="date" class="p-2 rounded" />
              <button id="btnCreateRoute" class="btn btn-primary">Crear</button>
            </div>

            <div id="routeBuilder" style="margin-top:8px; border:1px dashed rgba(255,255,255,0.06); min-height:240px; padding:8px; border-radius:8px;"></div>

            <div style="display:flex;gap:8px;margin-top:8px;">
              <button id="btnSaveRoute" class="btn btn-primary" style="display:none">Guardar ruta</button>
              <button id="btnClearRoute" class="btn">Limpiar</button>
              <button id="btnSendDriver" class="btn" style="display:none">Enviar a chofer</button>
            </div>

            <div style="margin-top:12px;">
              <h4>Rutas guardadas</h4>
              <div id="savedRoutes" style="max-height:180px;overflow:auto;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- CLIENTS -->
      <section id="page-clients" class="card page hidden">
        <h3>Clientes</h3>
        <div style="display:flex;gap:8px;margin-top:8px;"><input id="qClients" placeholder="Buscar..." class="w-full p-2 rounded" /><button id="btnNewClient" class="btn btn-primary">Nuevo</button></div>
        <div id="clientsArea" style="max-height:520px;overflow:auto;margin-top:8px;"></div>
      </section>

      <!-- DRIVERS -->
      <section id="page-drivers" class="card page hidden">
        <h3>Choferes</h3>
        <div style="display:flex;gap:8px;margin-top:8px;"><input id="inDriverName" placeholder="Nombre" class="p-2 rounded" /><input id="inDriverPhone" placeholder="Tel" class="p-2 rounded" /><button id="btnAddDriver" class="btn btn-primary">Agregar</button></div>
        <div id="driversArea" style="max-height:520px;overflow:auto;margin-top:8px;"></div>
      </section>

      <!-- VEHICLES -->
      <section id="page-vehicles" class="card page hidden">
        <h3>Veh√≠culos</h3>
        <div style="display:flex;gap:8px;margin-top:8px;"><input id="inVehModel" placeholder="Modelo" class="p-2 rounded" /><input id="inVehPlate" placeholder="Patente" class="p-2 rounded" /><button id="btnAddVeh" class="btn btn-primary">Agregar</button></div>
        <div id="vehiclesArea" style="max-height:520px;overflow:auto;margin-top:8px;"></div>
      </section>

      <!-- TICKETS -->
      <section id="page-tickets" class="card page hidden">
        <h3>Tickets</h3>
        <div class="muted">Buscar y generar ticket</div>
        <div style="display:flex;gap:8px;margin-top:8px;"><input id="qTickets" placeholder="Buscar..." class="w-full p-2 rounded" /><button id="btnSearchTicket" class="btn btn-primary">Buscar</button></div>
        <div id="ticketsArea" style="max-height:420px;overflow:auto;margin-top:8px;"></div>
      </section>

      <!-- SETTINGS -->
      <section id="page-settings" class="card page hidden">
        <h3>Ajustes</h3>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
          <label class="muted">Auto-backup diario</label>
          <select id="autoBackup" class="p-2 rounded"><option value="0">Desactivado</option><option value="1">Cada d√≠a</option></select>
          <label class="muted">Firebase sync</label>
          <input id="chkFirebase" type="checkbox" />
          <button id="btnSetFirebase" class="btn">Configurar Firebase</button>
        </div>

        <div style="margin-top:12px;">
          <h4>Backups locales</h4>
          <div id="backupsList" style="max-height:240px;overflow:auto;"></div>
          <div style="margin-top:8px;"><button id="btnBackupNow" class="btn">Backup ahora</button></div>
        </div>
      </section>

    </main>
  </div>

  <!-- Modal -->
  <div id="modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:60;">
    <div style="width:820px;max-width:95%;background:var(--card-dark);border-radius:12px;padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;"><strong id="modalTitle"></strong><button id="modalClose" class="btn">Cerrar</button></div>
      <div id="modalBody" style="margin-top:12px"></div>
    </div>
  </div>

<script defer>
/* MG Transporte ‚Äî Simplificado
 - Single file app
 - localStorage (offline) + optional Firebase sync (paste config)
 - Leaflet map planner, tickets (jsPDF), backups (SheetJS)
*/

/* ---------- Helpers & storage keys ---------- */
const uid = ()=> Math.random().toString(36).slice(2,9).toUpperCase();
const nowISO = ()=> new Date().toISOString();
const KEYS = {
  trips:'mg_v6_trips',
  drivers:'mg_v6_drivers',
  vehicles:'mg_v6_vehicles',
  clients:'mg_v6_clients',
  routes:'mg_v6_routes',
  backups:'mg_v6_backups',
  settings:'mg_v6_settings',
  queue:'mg_v6_queue'
};
const read = k => JSON.parse(localStorage.getItem(k) || '[]');
const write = (k,v) => localStorage.setItem(k, JSON.stringify(v));

/* state */
let trips = read(KEYS.trips);
let drivers = read(KEYS.drivers);
let vehicles = read(KEYS.vehicles);
let clients = read(KEYS.clients);
let routes = read(KEYS.routes);
let backups = read(KEYS.backups);
let queue = read(KEYS.queue);
let settings = JSON.parse(localStorage.getItem(KEYS.settings) || JSON.stringify({ theme:'dark', autoBackup:1, firebaseEnabled:false, firebaseConfig:{} }));

/* DOM refs */
const pages = document.querySelectorAll('.nav button');
const pageTitle = document.getElementById('pageTitle'), pageSub = document.getElementById('pageSub');
const themeToggle = document.getElementById('themeToggle');
const syncStatus = document.getElementById('syncStatus'), backupCount = document.getElementById('backupCount');

const inClient = document.getElementById('inClient'), inPhone = document.getElementById('inPhone'), inOrigin = document.getElementById('inOrigin'), inOriginLocal = document.getElementById('inOriginLocal'), inDest = document.getElementById('inDest'), inDestLocal = document.getElementById('inDestLocal'), inDate = document.getElementById('inDate'), inTime = document.getElementById('inTime'), inPrice = document.getElementById('inPrice'), inPax = document.getElementById('inPax'), inPet = document.getElementById('inPet'), inMinors = document.getElementById('inMinors'), inService = document.getElementById('inService'), inNotes = document.getElementById('inNotes');
const btnSaveTrip = document.getElementById('btnSaveTrip'), btnResetForm = document.getElementById('btnResetForm');
const tbodyTrips = document.getElementById('tbodyTrips'), qTrips = document.getElementById('qTrips'), filterState = document.getElementById('filterState');

const pendingList = document.getElementById('pendingList'), routeBuilder = document.getElementById('routeBuilder'), mapEl = document.getElementById('mapPlanner');
const selDriver = document.getElementById('selDriver'), selVehicle = document.getElementById('selVehicle'), selRouteDate = document.getElementById('selRouteDate'), btnCreateRoute = document.getElementById('btnCreateRoute'), btnSaveRoute = document.getElementById('btnSaveRoute'), btnClearRoute = document.getElementById('btnClearRoute'), btnSendDriver = document.getElementById('btnSendDriver'), savedRoutes = document.getElementById('savedRoutes');

const inDriverName = document.getElementById('inDriverName'), inDriverPhone = document.getElementById('inDriverPhone'), btnAddDriver = document.getElementById('btnAddDriver'), driversArea = document.getElementById('driversArea');
const inVehModel = document.getElementById('inVehModel'), inVehPlate = document.getElementById('inVehPlate'), btnAddVeh = document.getElementById('btnAddVeh'), vehiclesArea = document.getElementById('vehiclesArea');

const qTickets = document.getElementById('qTickets'), btnSearchTicket = document.getElementById('btnSearchTicket'), ticketsArea = document.getElementById('ticketsArea');

const btnExportPlan = document.getElementById('btnExportPlan'), btnExportJSON = document.getElementById('btnExportJSON'), btnImportJSON = document.getElementById('btnImportJSON');
const modal = document.getElementById('modal'), modalTitle = document.getElementById('modalTitle'), modalBody = document.getElementById('modalBody'), modalClose = document.getElementById('modalClose');

const btnOptimize = document.getElementById('btnOptimize');
const btnSetFirebase = document.getElementById('btnSetFirebase'), chkFirebase = document.getElementById('chkFirebase'), autoBackup = document.getElementById('autoBackup'), btnBackupNow = document.getElementById('btnBackupNow'), backupsList = document.getElementById('backupsList');

/* map */
let map=null, markersLayer=null, poly=null, nominatimCache={};
function initMap(){
  try{
    map = L.map(mapEl).setView([-34.61,-58.37], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap' }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
    poly = L.polyline([], { color:'#06b6d4', weight:4 }).addTo(map);
  }catch(e){ console.warn('map init', e); }
}
initMap();

/* geocode with cache */
async function geocode(address){
  if(!address) return null;
  const key = address.trim().toLowerCase();
  if(nominatimCache[key]) return nominatimCache[key];
  try{
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`, { headers:{ 'Accept-Language':'es' }});
    if(!res.ok) return null;
    const data = await res.json();
    if(!data || !data.length) return null;
    const p = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
    nominatimCache[key]=p; return p;
  }catch(e){ console.warn('geocode', e); return null; }
}

/* ---------- UI helpers ---------- */
function applyTheme(t){ document.body.setAttribute('data-theme', t); settings.theme = t; localStorage.setItem(KEYS.settings, JSON.stringify(settings)); }
themeToggle.addEventListener('click', ()=> applyTheme(document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));
applyTheme(settings.theme || 'dark');

pages.forEach(btn => btn.addEventListener('click', ()=> {
  pages.forEach(b=> b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.page').forEach(p=> p.classList.add('hidden'));
  const id = btn.dataset.page; document.getElementById(id).classList.remove('hidden');
  const titleMap = { 'page-trips':['Viajes','Crear y listar viajes'], 'page-plan':['Planificar','Asignar viajes a rutas'], 'page-clients':['Clientes','Gestionar clientes'], 'page-drivers':['Choferes','Gesti√≥n de choferes'], 'page-vehicles':['Veh√≠culos','Gesti√≥n de veh√≠culos'], 'page-tickets':['Tickets','Generar tickets'], 'page-settings':['Ajustes','Backups y sync'] };
  const info = titleMap[id] || ['MG',''];
  pageTitle.textContent = info[0]; pageSub.textContent = info[1];
}));

/* persist */
function persistAll(){ write(KEYS.trips,trips); write(KEYS.drivers,drivers); write(KEYS.vehicles,vehicles); write(KEYS.clients,clients); write(KEYS.routes,routes); write(KEYS.backups,backups); write(KEYS.queue, queue); document.getElementById('backupCount').textContent = backups.length; }

/* ---------- Renders ---------- */
function formatMoney(v){ return `$ ${Number(v||0).toFixed(2)}`; }
function esc(s){ if(s===undefined||s===null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

/* trips table */
function renderTrips(){
  tbodyTrips.innerHTML = '';
  const q = (qTrips.value||'').toLowerCase();
  const state = filterState.value;
  const arr = trips.filter(t=> (state==='all' || (t.status||'Activo') === state) && (!q || (t.clientName||'').toLowerCase().includes(q) || (t.localityOrigin||'').toLowerCase().includes(q))).sort((a,b)=> ((a.date||'')+' '+(a.time||'')).localeCompare((b.date||'')+' '+(b.time||'')));
  if(!arr.length){ tbodyTrips.innerHTML = '<tr><td colspan="6" class="muted">No hay viajes</td></tr>'; return; }
  arr.forEach(t=>{
    const status = t.status==='Finalizado' ? `<span class="status status-fin">Finalizado</span>` : (t.isAssigned ? `<span class="status status-asig">Asignado</span>` : `<span class="status status-pend">Pendiente</span>`);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><strong>${esc(t.clientName)}</strong><div class="muted">${esc(t.phone)}</div></td>
      <td>${esc(t.localityOrigin)} ${esc(t.addressOrigin)} ‚Üí ${esc(t.localityDest)} ${esc(t.addressDest)}</td>
      <td>${esc(t.date)} ${esc(t.time)}</td>
      <td><strong>${formatMoney(t.price)}</strong></td>
      <td>${status}</td>
      <td style="white-space:nowrap">
        <button class="btn btn-ghost btn-edit" data-id="${t.id}">Editar</button>
        <button class="btn btn-ghost btn-ticket" data-id="${t.id}">Ticket</button>
        ${t.status!=='Finalizado'? `<button class="btn btn-ghost btn-finish" data-id="${t.id}">Finalizar</button>` : `<button class="btn btn-ghost btn-reopen" data-id="${t.id}">Reabrir</button>`}
        ${!t.isAssigned ? `<button class="btn btn-ghost btn-assign" data-id="${t.id}">Asignar</button>` : `<button class="btn btn-ghost btn-unassign" data-id="${t.id}">Desasignar</button>`}
      </td>`;
    tbodyTrips.appendChild(tr);
  });
  // attach handlers
  document.querySelectorAll('.btn-edit').forEach(b=> b.onclick = e=> openEditTrip(e.currentTarget.dataset.id));
  document.querySelectorAll('.btn-ticket').forEach(b=> b.onclick = e=> openTicketOptions(e.currentTarget.dataset.id));
  document.querySelectorAll('.btn-finish').forEach(b=> b.onclick = e=> finalizeTrip(e.currentTarget.dataset.id));
  document.querySelectorAll('.btn-reopen').forEach(b=> b.onclick = e=> reopenTrip(e.currentTarget.dataset.id));
  document.querySelectorAll('.btn-assign').forEach(b=> b.onclick = e=> addTripToRoute(e.currentTarget.dataset.id));
  document.querySelectorAll('.btn-unassign').forEach(b=> b.onclick = e=> unassignTrip(e.currentTarget.dataset.id));
}

/* pending list */
function renderPending(){
  pendingList.innerHTML = '';
  const arr = trips.filter(t=> !t.isAssigned && (t.status||'Activo') !== 'Finalizado').sort((a,b)=> ((a.date||'')+' '+(a.time||'')).localeCompare((b.date||'')+' '+(b.time||'')));
  if(!arr.length){ pendingList.innerHTML = '<div class="muted">No hay viajes pendientes</div>'; return; }
  arr.forEach(t=>{
    const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px'; div.draggable = true; div.dataset.tripId = t.id;
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${esc(t.clientName)}</strong><div class="muted small">${esc(t.localityOrigin)}‚Üí${esc(t.localityDest)} ¬∑ ${esc(t.date)} ${esc(t.time)}</div></div><div style="text-align:right"><div><strong>${formatMoney(t.price)}</strong></div><div style="display:flex;gap:6px;margin-top:6px;"><button class="btn btn-ghost btn-add" data-id="${t.id}">Agregar</button><button class="btn btn-ghost btn-edit-small" data-id="${t.id}">‚úé</button></div></div></div>`;
    pendingList.appendChild(div);
  });
  pendingList.querySelectorAll('.btn-add').forEach(b=> b.onclick = e=> addTripToRoute(e.currentTarget.dataset.id));
  pendingList.querySelectorAll('.btn-edit-small').forEach(b=> b.onclick = e=> openEditTrip(e.currentTarget.dataset.id));
  if(window.pendingSortable) window.pendingSortable.destroy();
  window.pendingSortable = Sortable.create(pendingList, { group:{ name:'shared', pull:'clone', put:false }, sort:false, animation:150 });
}

/* drivers/vehicles/clients renders */
function renderDrivers(){
  driversArea.innerHTML = ''; selDriver.innerHTML = '<option value="">-- Seleccionar --</option>';
  if(!drivers.length){ driversArea.innerHTML = '<div class="muted">Sin choferes</div>'; return; }
  drivers.forEach(d=>{
    selDriver.innerHTML += `<option value="${d.id}">${esc(d.name)}</option>`;
    const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${esc(d.name)}</strong><div class="muted">${esc(d.phone)}</div></div><div style="display:flex;gap:6px;"><button class="btn btn-ghost btn-edit-driver" data-id="${d.id}">Editar</button><button class="btn btn-ghost btn-del-driver" data-id="${d.id}">Eliminar</button></div></div>`;
    driversArea.appendChild(div);
  });
  driversArea.querySelectorAll('.btn-edit-driver').forEach(b=> b.onclick = e=> editDriver(e.currentTarget.dataset.id));
  driversArea.querySelectorAll('.btn-del-driver').forEach(b=> b.onclick = e=> deleteDriver(e.currentTarget.dataset.id));
}
function renderVehicles(){
  vehiclesArea.innerHTML = ''; selVehicle.innerHTML = '<option value="">-- Seleccionar --</option>';
  if(!vehicles.length){ vehiclesArea.innerHTML = '<div class="muted">Sin veh√≠culos</div>'; return; }
  vehicles.forEach(v=>{
    selVehicle.innerHTML += `<option value="${v.id}">${esc(v.model)} (${esc(v.plate)})</option>`;
    const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${esc(v.model)}</strong><div class="muted">${esc(v.plate)}</div></div><div style="display:flex;gap:6px;"><button class="btn btn-ghost btn-edit-veh" data-id="${v.id}">Editar</button><button class="btn btn-ghost btn-del-veh" data-id="${v.id}">Eliminar</button></div></div>`;
    vehiclesArea.appendChild(div);
  });
  vehiclesArea.querySelectorAll('.btn-edit-veh').forEach(b=> b.onclick = e=> editVehicle(e.currentTarget.dataset.id));
  vehiclesArea.querySelectorAll('.btn-del-veh').forEach(b=> b.onclick = e=> deleteVehicle(e.currentTarget.dataset.id));
}
function renderClients(){
  clientsArea.innerHTML = '';
  if(!clients.length){ clientsArea.innerHTML = '<div class="muted">Sin clientes</div>'; return; }
  clients.forEach(c=>{
    const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${esc(c.name)}</strong><div class="muted">${esc(c.phone)}</div></div><div style="display:flex;gap:6px;"><button class="btn btn-ghost btn-edit-client" data-id="${c.id}">Editar</button><button class="btn btn-ghost btn-del-client" data-id="${c.id}">Eliminar</button></div></div>`;
    clientsArea.appendChild(div);
  });
  clientsArea.querySelectorAll('.btn-edit-client').forEach(b=> b.onclick = e=> editClient(e.currentTarget.dataset.id));
  clientsArea.querySelectorAll('.btn-del-client').forEach(b=> b.onclick = e=> deleteClient(e.currentTarget.dataset.id));
}

/* routes render */
function renderSavedRoutes(){
  savedRoutes.innerHTML = '';
  if(!routes.length){ savedRoutes.innerHTML = '<div class="muted">No hay rutas guardadas.</div>'; return; }
  routes.forEach(r=>{
    const drv = drivers.find(d=> d.id===r.driverId), veh = vehicles.find(v=> v.id===r.vehicleId);
    const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${esc(drv?.name||'Sin chofer')}</strong><div class="muted">${esc(veh?.model||'')} ¬∑ ${esc(r.date)}</div><div class="muted">Paradas: ${r.stops.length}</div></div><div style="display:flex;gap:6px;"><button class="btn btn-ghost btn-view-route" data-id="${r.id}">Ver</button><button class="btn btn-ghost btn-del-route" data-id="${r.id}">Eliminar</button></div></div>`;
    savedRoutes.appendChild(div);
  });
  savedRoutes.querySelectorAll('.btn-view-route').forEach(b=> b.onclick = e=> viewRoute(e.currentTarget.dataset.id));
  savedRoutes.querySelectorAll('.btn-del-route').forEach(b=> b.onclick = e=> deleteRoute(e.currentTarget.dataset.id));
}

/* route builder */
let currentRoute = null;
function renderRouteBuilder(){
  routeBuilder.innerHTML = '';
  if(!currentRoute){ routeBuilder.innerHTML = '<div class="muted">No hay ruta en construcci√≥n</div>'; btnSaveRoute.style.display='none'; btnSendDriver.style.display='none'; return; }
  if(!currentRoute.stops.length){ routeBuilder.innerHTML = '<div class="muted">Ruta vac√≠a. Agreg√° viajes</div>'; btnSaveRoute.style.display='none'; btnSendDriver.style.display='none'; return; }
  currentRoute.stops.forEach(tid=>{
    const t = trips.find(x=> x.id===tid); if(!t) return;
    const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px'; div.dataset.id = t.id;
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${esc(t.clientName)}</strong><div class="muted">${esc(t.localityOrigin)}‚Üí${esc(t.localityDest)} ¬∑ ${esc(t.date)} ${esc(t.time)}</div></div><div style="display:flex;gap:6px;"><button class="btn btn-ghost btn-up" data-id="${t.id}">‚ñ≤</button><button class="btn btn-ghost btn-down" data-id="${t.id}">‚ñº</button><button class="btn btn-ghost btn-remove" data-id="${t.id}">Quitar</button></div></div>`;
    routeBuilder.appendChild(div);
  });
  routeBuilder.querySelectorAll('.btn-up').forEach(b=> b.onclick = e=> moveUp(e.currentTarget.dataset.id));
  routeBuilder.querySelectorAll('.btn-down').forEach(b=> b.onclick = e=> moveDown(e.currentTarget.dataset.id));
  routeBuilder.querySelectorAll('.btn-remove').forEach(b=> b.onclick = e=> removeFromRoute(e.currentTarget.dataset.id));
  btnSaveRoute.style.display = 'inline-flex'; btnSendDriver.style.display = 'inline-flex';

  if(window.routeSortable) window.routeSortable.destroy();
  window.routeSortable = Sortable.create(routeBuilder, { group:{ name:'shared', put:true, pull:false }, animation:150, onAdd(evt){ const tid = evt.item.dataset.tripId || evt.item.getAttribute('data-trip-id'); if(tid) addTripToRoute(tid); evt.item.remove(); }, onUpdate(){ currentRoute.stops = Array.from(routeBuilder.children).map(c=> c.dataset.id).filter(Boolean); updateMapForRoute(); } });
}

/* update map for route */
async function updateMapForRoute(){
  if(!map || !currentRoute) return;
  markersLayer.clearLayers(); poly.setLatLngs([]);
  const coords = [];
  for(const tid of currentRoute.stops){
    const t = trips.find(x=> x.id===tid); if(!t) continue;
    const addr = `${t.addressOrigin} ${t.localityOrigin}`;
    const p = await geocode(addr);
    if(p){ coords.push([p.lat,p.lon]); L.marker([p.lat,p.lon]).bindPopup(`<b>${esc(t.clientName)}</b><br>${esc(t.localityOrigin)}‚Üí${esc(t.localityDest)}`).addTo(markersLayer); }
  }
  if(coords.length){ poly.setLatLngs(coords); try{ map.fitBounds(poly.getBounds().pad(0.4)); }catch(e){} }
}

/* ---------- CRUD actions ---------- */

/* TRIPS */
let editingTripId = null;
btnSaveTrip.addEventListener('click', async ()=>{
  const data = {
    clientName: inClient.value.trim(), phone: inPhone.value.trim(),
    addressOrigin: inOrigin.value.trim(), localityOrigin: inOriginLocal.value.trim(),
    addressDest: inDest.value.trim(), localityDest: inDestLocal.value.trim(),
    date: inDate.value, time: inTime.value, price: parseFloat(inPrice.value||0),
    passengers: parseInt(inPax.value||1), pet: inPet.value, minors: inMinors.value, service: inService.value, notes: inNotes.value
  };
  const err = validateTrip(data); if(err){ alert(err); return; }
  if(editingTripId){ const i = trips.findIndex(x=> x.id===editingTripId); if(i>=0){ trips[i] = { ...trips[i], ...data, updatedAt: nowISO() }; alert('Viaje actualizado'); editingTripId=null; document.getElementById('formMode').textContent='Nuevo'; } }
  else { trips.unshift({ id: uid(), ...data, isAssigned:false, assignedRouteId:null, status:'Activo', createdAt: nowISO() }); alert('Viaje creado'); }
  persistAll(); renderAll(); resetForm();
  maybeQueuePush('trip', data);
});

function validateTrip(t){ if(!t.clientName) return 'Nombre obligatorio'; if(!t.phone) return 'Tel√©fono obligatorio'; if(!t.addressOrigin) return 'Origen obligatorio'; if(!t.addressDest) return 'Destino obligatorio'; if(!t.date) return 'Fecha obligatoria'; if(!t.time) return 'Hora obligatoria'; if(isNaN(t.price)) return 'Precio inv√°lido'; return null; }

function resetForm(){ inClient.value=''; inPhone.value=''; inOrigin.value=''; inOriginLocal.value=''; inDest.value=''; inDestLocal.value=''; inDate.value=''; inTime.value=''; inPrice.value=''; inPax.value='1'; inPet.value='none'; inMinors.value='no'; inService.value='compartido'; inNotes.value=''; editingTripId=null; document.getElementById('formMode').textContent='Nuevo'; }

function openEditTrip(id){
  const t = trips.find(x=> x.id===id); if(!t) return;
  editingTripId = id; document.getElementById('formMode').textContent='Editando';
  inClient.value = t.clientName; inPhone.value = t.phone; inOrigin.value = t.addressOrigin; inOriginLocal.value = t.localityOrigin; inDest.value = t.addressDest; inDestLocal.value = t.localityDest; inDate.value = t.date; inTime.value = t.time; inPrice.value = t.price; inPax.value = t.passengers||1; inPet.value = t.pet||'none'; inMinors.value = t.minors||'no'; inService.value = t.service||'compartido'; inNotes.value = t.notes||'';
  window.scrollTo({ top:0, behavior:'smooth' });
}

function finalizeTrip(id){ if(!confirm('Marcar viaje como finalizado?')) return; const t = trips.find(x=> x.id===id); if(!t) return; t.status='Finalizado'; persistAll(); renderAll(); }
function reopenTrip(id){ if(!confirm('Reabrir viaje?')) return; const t = trips.find(x=> x.id===id); if(!t) return; t.status='Activo'; persistAll(); renderAll(); }
function unassignTrip(id){ const t = trips.find(x=> x.id===id); if(!t) return; if(!confirm('Desasignar viaje?')) return; t.isAssigned = false; t.assignedRouteId = null; persistAll(); renderAll(); }

/* DRIVER actions */
document.getElementById('btnAddDriver')?.addEventListener('click', ()=> {
  const n = inDriverName.value.trim(); const p = inDriverPhone.value.trim();
  if(!n){ alert('Nombre requerido'); return; }
  drivers.unshift({ id: uid(), name:n, phone:p, createdAt: nowISO() }); inDriverName.value=''; inDriverPhone.value=''; persistAll(); renderAll();
});
function editDriver(id){ const d = drivers.find(x=> x.id===id); if(!d) return; const nn = prompt('Nombre', d.name); if(nn===null) return; const pp = prompt('Tel', d.phone); d.name=nn; d.phone=pp; persistAll(); renderAll(); }
function deleteDriver(id){ if(!confirm('Eliminar chofer?')) return; drivers = drivers.filter(x=> x.id!==id); persistAll(); renderAll(); }

/* VEHICLES */
document.getElementById('btnAddVeh')?.addEventListener('click', ()=> {
  const m = inVehModel.value.trim(); const pl = inVehPlate.value.trim();
  if(!m || !pl){ alert('Modelo y patente requeridos'); return; }
  vehicles.unshift({ id: uid(), model:m, plate:pl, createdAt: nowISO() }); inVehModel.value=''; inVehPlate.value=''; persistAll(); renderAll();
});
function editVehicle(id){ const v=vehicles.find(x=> x.id===id); if(!v) return; const nm=prompt('Modelo',v.model); if(nm===null) return; const np=prompt('Patente',v.plate); v.model=nm; v.plate=np; persistAll(); renderAll(); }
function deleteVehicle(id){ if(!confirm('Eliminar veh√≠culo?')) return; vehicles = vehicles.filter(x=> x.id!==id); persistAll(); renderAll(); }

/* CLIENTS */
document.getElementById('btnNewClient')?.addEventListener('click', ()=> {
  const name = prompt('Nombre cliente'); if(!name) return; const phone = prompt('Tel√©fono')||''; clients.unshift({ id: uid(), name, phone, createdAt: nowISO() }); persistAll(); renderAll();
});
function editClient(id){ const c=clients.find(x=> x.id===id); if(!c) return; const nn=prompt('Nombre',c.name); if(nn===null) return; const pp=prompt('Tel',c.phone); c.name=nn; c.phone=pp; persistAll(); renderAll(); }
function deleteClient(id){ if(!confirm('Eliminar cliente?')) return; clients = clients.filter(x=> x.id!==id); persistAll(); renderAll(); }

/* ---------- Routes actions ---------- */
btnCreateRoute.addEventListener('click', ()=> {
  const driverId = selDriver.value, vehicleId = selVehicle.value, date = selRouteDate.value;
  if(!driverId || !vehicleId || !date) return alert('Seleccion√° chofer, veh√≠culo y fecha');
  currentRoute = { id: uid(), driverId, vehicleId, date, stops: [], createdAt: nowISO(), status:'Activa' };
  renderRouteBuilder(); alert('Ruta creada. Agreg√° viajes desde la izquierda.');
});

function addTripToRoute(tripId){
  if(!currentRoute){ alert('Crea una ruta primero'); return; }
  if(currentRoute.stops.includes(tripId)){ alert('Viaje ya agregado'); return; }
  currentRoute.stops.push(tripId);
  const t = trips.find(x=> x.id===tripId); if(t){ t.isAssigned=true; }
  renderRouteBuilder(); renderPending(); updateMapForRoute();
}

function moveUp(id){ const i=currentRoute.stops.indexOf(id); if(i>0){ [currentRoute.stops[i-1], currentRoute.stops[i]]=[currentRoute.stops[i], currentRoute.stops[i-1]]; renderRouteBuilder(); updateMapForRoute(); } }
function moveDown(id){ const i=currentRoute.stops.indexOf(id); if(i>=0 && i<currentRoute.stops.length-1){ [currentRoute.stops[i+1], currentRoute.stops[i]]=[currentRoute.stops[i], currentRoute.stops[i+1]]; renderRouteBuilder(); updateMapForRoute(); } }
function removeFromRoute(id){ currentRoute.stops = currentRoute.stops.filter(x=> x!==id); const t = trips.find(x=> x.id===id); if(t) t.isAssigned=false; renderRouteBuilder(); renderPending(); updateMapForRoute(); }

btnClearRoute.addEventListener('click', ()=> { if(!confirm('Limpiar ruta?')) return; if(currentRoute){ currentRoute.stops.forEach(tid=> { const t = trips.find(x=> x.id===tid); if(t) t.isAssigned=false; }); currentRoute=null; renderRouteBuilder(); renderPending(); updateMapForRoute(); } });

btnSaveRoute.addEventListener('click', ()=> {
  if(!currentRoute || !currentRoute.stops.length) return alert('Ruta vac√≠a');
  const r = { id: uid(), driverId: currentRoute.driverId, vehicleId: currentRoute.vehicleId, date: currentRoute.date, stops:[...currentRoute.stops], createdAt: nowISO(), status:'Activa' };
  routes.unshift(r);
  for(const tid of currentRoute.stops){ const t = trips.find(x=> x.id===tid); if(t){ t.isAssigned=true; t.assignedRouteId=r.id; } }
  persistAll(); currentRoute=null; renderAll(); alert('Ruta guardada');
});

btnSendDriver.addEventListener('click', ()=> {
  if(!currentRoute) return alert('No hay ruta'); const drv = drivers.find(d=> d.id===currentRoute.driverId); if(!drv) return alert('Chofer no encontrado');
  let text = `Ruta ${currentRoute.date}\nChofer: ${drv.name}\nParadas:\n`; currentRoute.stops.forEach(tid=>{ const t = trips.find(x=> x.id===tid); text += `- ${t.clientName} ${t.localityOrigin}‚Üí${t.localityDest} ${t.date} ${t.time} Tel:${t.phone}\n`; });
  window.open(`https://wa.me/${(drv.phone||'').replace(/\D/g,'')}?text=${encodeURIComponent(text)}`,'_blank');
});

function viewRoute(id){ const r = routes.find(x=> x.id===id); if(!r) return; let txt = `Ruta ${r.date}\nChofer: ${drivers.find(d=> d.id===r.driverId)?.name || 'N/D'}\nVeh: ${vehicles.find(v=> v.id===r.vehicleId)?.model || 'N/D'}\nParadas:\n`; r.stops.forEach(tid=>{ const t=trips.find(x=> x.id===tid); txt+=`- ${t.clientName} | ${t.localityOrigin}‚Üí${t.localityDest} ${t.date} ${t.time}\n`; }); const ok = confirm(txt + '\nOK = eliminar y desasignar'); if(ok){ for(const tid of r.stops){ const t = trips.find(x=> x.id===tid); if(t){ t.isAssigned=false; t.assignedRouteId=null; } } routes = routes.filter(x=> x.id!==id); persistAll(); renderAll(); } }
function deleteRoute(id){ if(!confirm('Eliminar ruta?')) return; const r = routes.find(x=> x.id===id); if(r){ for(const tid of r.stops){ const t = trips.find(x=> x.id===tid); if(t){ t.isAssigned=false; t.assignedRouteId=null; } } } routes = routes.filter(x=> x.id!==id); persistAll(); renderAll(); }

/* ---------- Tickets (client & driver) ---------- */
const { jsPDF } = window.jspdf || {};
function ticketText(t){
  const r = routes.find(rr=> rr.id === t.assignedRouteId);
  const drv = r? drivers.find(d=> d.id===r.driverId) : null; const veh = r? vehicles.find(v=> v.id===r.vehicleId) : null;
  return `MG Transporte - Ticket\nViaje: ${t.date} ${t.time}\nPasajero: ${t.clientName}\nTel: ${t.phone}\nOrigen: ${t.addressOrigin}, ${t.localityOrigin}\nDestino: ${t.addressDest}, ${t.localityDest}\nPasajeros: ${t.passengers}\nMascota: ${t.pet}\nMenores: ${t.minors}\nServicio: ${t.service}\nPrecio: ${formatMoney(t.price)}\nObservaciones: ${t.notes}\nChofer: ${drv? drv.name + ' - ' + (drv.phone||'') : 'Sin asignar'}\nVeh√≠culo: ${veh? veh.model + ' - ' + (veh.plate||'') : 'Sin asignar'}`;
}
function openTicketOptions(tripId){
  const t = trips.find(x=> x.id===tripId); if(!t) return;
  showModal('Opciones ticket', `<div style="display:flex;flex-direction:column;gap:8px"><div><strong>${esc(t.clientName)}</strong> ‚Äî ${esc(t.date)} ${esc(t.time)}</div><div style="display:flex;gap:8px"><button id="m-wa" class="btn btn-primary">WhatsApp</button><button id="m-mail" class="btn">Email</button><button id="m-pdf" class="btn">Descargar PDF</button></div></div>`);
  document.getElementById('m-wa').onclick = ()=> { window.open(`https://wa.me/${(t.phone||'').replace(/\D/g,'')}?text=${encodeURIComponent(ticketText(t))}`,'_blank'); };
  document.getElementById('m-mail').onclick = ()=> { location.href = `mailto:${t.phone||''}?subject=${encodeURIComponent('Ticket MG Transporte')}&body=${encodeURIComponent(ticketText(t))}`; };
  document.getElementById('m-pdf').onclick = ()=> { generatePdf(t); hideModal(); };
}
function generatePdf(t){
  if(!jsPDF) return alert('jsPDF no cargado');
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  doc.setFontSize(16); doc.text('MG Transporte - Ticket', 40, 60);
  doc.setFontSize(11);
  let y=90; ticketText(t).split('\n').forEach(line=>{ doc.text(line, 40, y); y+=14; });
  doc.save(`ticket_${t.clientName.replace(/\s+/g,'_')}_${t.date}.pdf`);
}

/* ---------- Backups & SheetJS ---------- */
function buildWorkbook(data){
  const wb = XLSX.utils.book_new();
  const tripsRows = data.trips.map(t=>({ Fecha:t.date, Hora:t.time, Cliente:t.clientName, Celular:t.phone, 'Localidad Origen':t.localityOrigin, 'Direccion Origen':t.addressOrigin, 'Localidad Destino':t.localityDest, 'Direccion Destino':t.addressDest, Precio:t.price, Estado:t.status, Observaciones:t.notes }));
  const wsTrips = XLSX.utils.json_to_sheet(tripsRows);
  XLSX.utils.book_append_sheet(wb, wsTrips, 'Viajes');

  const wsRoutes = XLSX.utils.json_to_sheet(data.routes.map(r=> ({ id:r.id, date:r.date, driverId:r.driverId, vehicleId:r.vehicleId, stops:r.stops.join(',') })));
  XLSX.utils.book_append_sheet(wb, wsRoutes, 'Rutas');

  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.drivers), 'Choferes');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.vehicles), 'Veh√≠culos');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.clients), 'Clientes');
  return wb;
}
function downloadWorkbook(wb, filename){
  const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
  const blob = new Blob([wbout], { type:'application/octet-stream' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
}
function doBackup(note='auto'){
  const snap = { id: uid(), ts: nowISO(), note, data:{ trips, routes, drivers, vehicles, clients } };
  backups.unshift(snap);
  if(backups.length>60) backups = backups.slice(0,60);
  write(KEYS.backups, backups);
  backupCount.textContent = backups.length;
  const wb = buildWorkbook(snap.data);
  const fname = `backup_MGTransporte_${(new Date()).toISOString().slice(0,10)}.xlsx`;
  downloadWorkbook(wb, fname);
  renderBackups();
}

/* planilla (hoja por mes) */
function exportPlanilla(){
  const byMonth = {};
  trips.forEach(t=>{ const m = t.date ? t.date.slice(0,7) : 'SinFecha'; if(!byMonth[m]) byMonth[m]=[]; byMonth[m].push(t); });
  const wb = XLSX.utils.book_new();
  Object.keys(byMonth).sort().forEach(mon=>{
    const rows = byMonth[mon].map(t=> ({ Fecha:t.date, Hora:t.time, Cliente:t.clientName, Celular:t.phone, 'Localidad Origen':t.localityOrigin, 'Direccion Origen':t.addressOrigin, 'Localidad Destino':t.localityDest, 'Direccion Destino':t.addressDest, Precio:t.price, Estado:t.status, Observaciones:t.notes }) );
    const ws = XLSX.utils.json_to_sheet(rows);
    const total = rows.reduce((s,r)=> s + (Number(r.Precio)||0), 0);
    const lastRow = rows.length + 3;
    XLSX.utils.sheet_add_aoa(ws, [['Total viajes', rows.length], ['Total facturado', total]], { origin:`A${lastRow}`});
    XLSX.utils.book_append_sheet(wb, ws, mon);
  });
  const fname = `Planilla_Viajes_${(new Date()).toISOString().slice(0,10)}.xlsx`;
  downloadWorkbook(wb, fname);
}

/* export/import JSON */
function exportJSON(){
  const pack = { trips, drivers, vehicles, clients, routes, ts: nowISO() };
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(pack,null,2)], { type:'application/json' })); a.download = `mg_export_${nowISO().slice(0,10)}.json`; a.click();
}
function importJSON(){
  const fi = document.createElement('input'); fi.type='file'; fi.accept='application/json';
  fi.onchange = ev => {
    const f = ev.target.files[0]; if(!f) return;
    const r = new FileReader(); r.onload = ()=> {
      try{
        const obj = JSON.parse(r.result);
        if(obj.trips) trips = obj.trips; if(obj.drivers) drivers = obj.drivers; if(obj.vehicles) vehicles = obj.vehicles; if(obj.clients) clients = obj.clients; if(obj.routes) routes = obj.routes;
        persistAll(); renderAll(); alert('Importaci√≥n OK');
      }catch(e){ alert('Error importando JSON'); console.error(e); }
    }; r.readAsText(f);
  };
  fi.click();
}

/* ---------- Queue & Firebase (optional) ---------- */
function maybeQueuePush(type, payload){
  if(settings.firebaseEnabled && window.firebase && window.firebase.firestore && navigator.onLine){
    // push to firestore (simple)
    try{
      const db = firebase.firestore();
      if(type==='trip'){ db.collection('trips').doc(payload.id || uid()).set(payload); }
    }catch(e){ queue.unshift({ id:uid(), ts:nowISO(), type, payload }); write(KEYS.queue, queue); }
  } else {
    queue.unshift({ id:uid(), ts:nowISO(), type, payload }); write(KEYS.queue, queue);
  }
}
async function processQueue(){
  if(!settings.firebaseEnabled || !window.firebase || !navigator.onLine) { syncStatus.textContent = settings.firebaseEnabled ? 'Online (no conectado a Firebase)' : 'Local'; return; }
  syncStatus.textContent = 'Sincronizando...';
  const db = firebase.firestore();
  while(queue.length){
    const it = queue.pop();
    try{
      if(it.type==='trip'){ await db.collection('trips').doc(it.payload.id).set(it.payload); }
      // more types can be processed
      write(KEYS.queue, queue);
    }catch(e){ console.error('queue process err', e); queue.push(it); write(KEYS.queue, queue); break; }
  }
  syncStatus.textContent = 'Sincronizaci√≥n finalizada';
}

/* firebase init from modal */
function initFirebaseFromConfig(cfg){
  try{
    if(!cfg || !cfg.apiKey) return alert('Config inv√°lida');
    firebase.initializeApp(cfg);
    settings.firebaseEnabled = true; settings.firebaseConfig = cfg; localStorage.setItem(KEYS.settings, JSON.stringify(settings));
    chkFirebase.checked = true;
    processQueue();
    alert('Firebase inicializado');
  }catch(e){ alert('Error inicializando Firebase'); console.error(e); }
}

/* ---------- small utilities & modal ---------- */
function showModal(title, html){ modalTitle.textContent = title; modalBody.innerHTML = html; modal.style.display = 'flex'; }
function hideModal(){ modal.style.display = 'none'; }
modalClose.addEventListener('click', hideModal);

/* ticket search area */
function renderTicketsArea(){
  ticketsArea.innerHTML = ''; const q = (qTickets.value||'').toLowerCase();
  const arr = trips.filter(t=> !q || (t.clientName||'').toLowerCase().includes(q) || (t.localityOrigin||'').toLowerCase().includes(q));
  if(!arr.length){ ticketsArea.innerHTML = '<div class="muted">No hay viajes</div>'; return; }
  arr.forEach(t=>{
    const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${esc(t.clientName)}</strong><div class="muted">${esc(t.date)} ${esc(t.time)} ¬∑ ${esc(t.localityOrigin)}‚Üí${esc(t.localityDest)}</div></div><div style="display:flex;gap:8px;"><button class="btn btn-ghost btn-ticket-open" data-id="${t.id}">Opciones</button></div></div>`;
    ticketsArea.appendChild(div);
  });
  ticketsArea.querySelectorAll('.btn-ticket-open').forEach(b=> b.onclick = e=> openTicketOptions(e.currentTarget.dataset.id));
}

/* ---------- startup render ---------- */
function renderBackups(){ backupsList.innerHTML=''; if(!backups.length) backupsList.innerHTML='<div class="muted">Sin backups</div>'; backups.forEach(bk=>{ const div=document.createElement('div'); div.className='card'; div.style.marginBottom='8px'; div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${bk.ts}</strong><div class="muted">${bk.note}</div></div><div style="display:flex;gap:8px"><button class="btn btn-ghost btn-dl" data-id="${bk.id}">Descargar</button><button class="btn btn-ghost btn-restore" data-id="${bk.id}">Restaurar</button></div></div>`; backupsList.appendChild(div); }); backupsList.querySelectorAll('.btn-dl').forEach(b=> b.onclick = e=> { const id=e.currentTarget.dataset.id; const bk=backups.find(x=> x.id===id); if(!bk) return; const wb = buildWorkbook(bk.data); downloadWorkbook(wb, `backup_${bk.ts}.xlsx`); }); backupsList.querySelectorAll('.btn-restore').forEach(b=> b.onclick = e=> { if(!confirm('Restaurar backup?')) return; const id=e.currentTarget.dataset.id; const bk=backups.find(x=> x.id===id); if(!bk) return; trips=bk.data.trips||[]; drivers=bk.data.drivers||[]; vehicles=bk.data.vehicles||[]; clients=bk.data.clients||[]; routes=bk.data.routes||[]; persistAll(); renderAll(); alert('Backup restaurado'); }); document.getElementById('backupCount').textContent = backups.length; }

/* render all */
function renderAll(){ renderTrips(); renderPending(); renderDrivers(); renderVehicles(); renderClients(); renderSavedRoutes(); renderRouteBuilder(); renderTicketsArea(); renderBackups(); }

/* buttons wiring */
qTrips.addEventListener('input', renderTrips);
filterState.addEventListener('change', renderTrips);
btnResetForm.addEventListener('click', resetForm);
document.getElementById('btnExportPlan').addEventListener('click', exportPlanilla);
document.getElementById('btnExportJSON').addEventListener('click', exportJSON);
document.getElementById('btnImportJSON').addEventListener('click', importJSON);
document.getElementById('btnBackupNow').addEventListener('click', ()=> { doBackup('manual'); alert('Backup descargado'); });

document.getElementById('btnOptimize').addEventListener('click', ()=> {
  if(!currentRoute) return alert('Crea una ruta primero');
  currentRoute.stops.sort((a,b)=> ((trips.find(x=>x.id===a).date||'')+' '+(trips.find(x=>x.id===a).time||'')).localeCompare((trips.find(x=>x.id===b).date||'')+' '+(trips.find(x=>x.id===b).time||'')); renderRouteBuilder(); updateMapForRoute();
});

/* search ticket */
document.getElementById('btnSearchTicket').addEventListener('click', ()=> renderTicketsArea());
qTickets.addEventListener('input', renderTicketsArea);

/* modal firebase config */
btnSetFirebase.addEventListener('click', ()=> {
  showModal('Configurar Firebase', `<div style="display:flex;flex-direction:column;gap:8px"><div class="muted">Pega aqu√≠ el objeto de configuraci√≥n (JSON) de Firebase:</div><textarea id="fbConf" rows="8" class="w-full p-2"></textarea><div style="display:flex;gap:8px"><button id="fbSave" class="btn btn-primary">Guardar y conectar</button><button id="fbClear" class="btn">Cerrar</button></div></div>`);
  document.getElementById('fbSave').addEventListener('click', ()=> { try{ const cfg = JSON.parse(document.getElementById('fbConf').value); initFirebaseFromConfig(cfg); hideModal(); }catch(e){ alert('JSON inv√°lido'); } });
  document.getElementById('fbClear').addEventListener('click', hideModal);
});

/* auto backup scheduling (daily at approx midnight) */
function scheduleDaily(){
  if(Number(autoBackup.value) <= 0) return;
  const now = new Date(); const next = new Date(now); next.setHours(24,0,10,0);
  const ms = next - now;
  setTimeout(()=>{ doBackup('nightly'); setInterval(()=> doBackup('nightly'), 24*3600*1000); }, ms + 1000);
}
autoBackup.value = settings.autoBackup || 1;
autoBackup.addEventListener('change', ()=> { settings.autoBackup = Number(autoBackup.value); localStorage.setItem(KEYS.settings, JSON.stringify(settings)); if(settings.autoBackup>0) scheduleDaily(); });

/* simple online/offline */
window.addEventListener('online', ()=> { syncStatus.textContent = 'Online'; processQueue(); });
window.addEventListener('offline', ()=> { syncStatus.textContent = 'Offline'; });

/* initial data demo helper (only if empty) */
function loadSampleIfEmpty(){
  if(trips.length || drivers.length || vehicles.length || clients.length) return;
  drivers = [{ id: uid(), name:'Juan L√≥pez', phone:'115555000' }];
  vehicles = [{ id: uid(), model:'Renault Kangoo', plate:'ABC123' }];
  clients = [{ id: uid(), name:'Mar√≠a P', phone:'115000111' }];
  trips = [
    { id: uid(), clientName:'Mar√≠a P', phone:'115000111', addressOrigin:'Av. Col√≥n 123', localityOrigin:'Mar del Plata', addressDest:'Av. Costanera 200', localityDest:'Mar del Plata', date:'2025-12-20', time:'08:00', price:25000, passengers:1, pet:'none', minors:'no', service:'compartido', notes:'', isAssigned:false, assignedRouteId:null, status:'Activo', createdAt: nowISO() }
  ];
  persistAll();
}

/* startup */
function initApp(){ loadSampleIfEmpty(); renderAll(); scheduleDaily(); if(settings.firebaseEnabled && settings.firebaseConfig && Object.keys(settings.firebaseConfig).length) initFirebaseFromConfig(settings.firebaseConfig); }
initApp();

</script>
</body>
</html>
